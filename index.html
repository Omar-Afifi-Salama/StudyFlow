<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Time Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for body - dynamic themes will override these */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg-primary, #1a202c);
            color: var(--text-primary, #e2e8f0);
            min-height: 100vh;
            overflow-y: auto;
            /* Background animation - adjust colors based on active theme */
            background: linear-gradient(45deg, var(--bg-primary-gradient-start, #1a202c), var(--bg-primary-gradient-middle, #2d3748), var(--bg-primary-gradient-end, #1a202c));
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Default Dark Theme Variables */
        body.default-dark-skin {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #374151; /* For elements like checklist item background */
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e0; /* Gray-300 */
            --accent-blue: #4299e1; /* Blue-500 */
            --accent-green: #48bb78; /* Green-500 */
            --accent-yellow: #f6e05e; /* Yellow-400 */
            --accent-red: #fc8181; /* Red-400 */
            --accent-purple: #9f7aea; /* Purple-400 */
            --border-color: #4a5568; /* Gray-600 */
            --xp-fill-color: #63b3ed; /* Blue-400 */
            --sponsor-bg: #000000;
            --sponsor-border: #cc0000;
            --sponsor-highlight: #cc0000;
            --bg-primary-gradient-start: #1a202c;
            --bg-primary-gradient-middle: #2d3748;
            --bg-primary-gradient-end: #1a202c;
        }

        /* Default Light Theme Variables */
        body.default-light-skin {
            --bg-primary: #f0f4f8; /* Light gray-blue */
            --bg-secondary: #e2e8f0; /* Lighter gray-blue */
            --bg-tertiary: #ffffff; /* White for item backgrounds */
            --text-primary: #2d3748; /* Dark text */
            --text-secondary: #4a5568; /* Darker gray text */
            --accent-blue: #3182ce; /* Stronger blue */
            --accent-green: #38a169; /* Stronger green */
            --accent-yellow: #ecc94b; /* Stronger yellow */
            --accent-red: #e53e3e; /* Stronger red */
            --accent-purple: #805ad5; /* Stronger purple */
            --border-color: #a0aec0; /* Lighter gray border */
            --xp-fill-color: #4299e1; /* Blue-500 */
            --sponsor-bg: #000000; /* Keep sponsor colors consistent */
            --sponsor-border: #cc0000;
            --sponsor-highlight: #cc0000;
            background: linear-gradient(45deg, #f0f4f8, #e2e8f0, #f0f4f8);
        }

        /* Forest Dream Skin */
        body.forest-dream-skin {
            --bg-primary: #1e3a24; /* Dark forest green */
            --bg-secondary: #2d5736; /* Slightly lighter, richer green */
            --bg-tertiary: #3c7d49; /* Even lighter green for interactive elements */
            --text-primary: #e6ffe0; /* Very light, soft green */
            --text-secondary: #b3d8a7; /* Muted light green */
            --accent-blue: #6aa84f; /* Olive green */
            --accent-green: #90ee90; /* Pale green (for accents) */
            --accent-yellow: #d4a75e; /* Earthy brown-yellow */
            --accent-red: #c25c5c; /* Muted red */
            --accent-purple: #8c73a0; /* Dusky purple */
            --border-color: #4f6b53; /* Darker green border */
            --xp-fill-color: #79c063; /* Light green for XP bar */
            --sponsor-bg: #000000;
            --sponsor-border: #cc0000;
            --sponsor-highlight: #cc0000;
            background: linear-gradient(45deg, #1e3a24, #2d5736, #1e3a24);
        }

        /* Ocean Breeze Skin */
        body.ocean-breeze-skin {
            --bg-primary: #0a1f2e; /* Very dark blue, deep ocean */
            --bg-secondary: #1a3a54; /* Slightly lighter, more vibrant blue */
            --bg-tertiary: #2b577d; /* Medium blue for interactive elements */
            --text-primary: #e0faff; /* Very light, almost white blue */
            --text-secondary: #a7d9ed; /* Muted light blue */
            --accent-blue: #42a5f5; /* Bright sky blue */
            --accent-green: #68b2a1; /* Teal-green, like shallow water */
            --accent-yellow: #fdd835; /* Sunny yellow */
            --accent-red: #ef5350; /* Coral red */
            --accent-purple: #906cbf; /* Deep lavender */
            --border-color: #3b6b8e; /* Muted blue border */
            --xp-fill-color: #64b5f6; /* Bright blue for XP bar */
            --sponsor-bg: #000000;
            --sponsor-border: #cc0000;
            --sponsor-highlight: #cc0000;
            background: linear-gradient(45deg, #0a1f2e, #1a3a54, #0a1f2e);
        }

        /* Midnight Violet Skin */
        body.midnight-violet-skin {
            --bg-primary: #210a30; /* Very dark purple, almost black */
            --bg-secondary: #3b1b52; /* Richer, deeper purple */
            --bg-tertiary: #5a2e7c; /* Brighter purple for interactive elements */
            --text-primary: #f0e6ff; /* Very light, soft purple */
            --text-secondary: #c9b0e2; /* Muted light purple */
            --accent-blue: #b39ddb; /* Lavender blue */
            --accent-green: #a7d88c; /* Muted green */
            --accent-yellow: #ffeb3b; /* Bright yellow */
            --accent-red: #ef9a9a; /* Light red */
            --accent-purple: #d1c4e9; /* Very light purple (for accents) */
            --border-color: #4d316d; /* Dark purple border */
            --xp-fill-color: #a787d9; /* Medium purple for XP bar */
            --sponsor-bg: #000000;
            --sponsor-border: #cc0000;
            --sponsor-highlight: #cc0000;
            background: linear-gradient(45deg, #210a30, #3b1b52, #210a30);
        }


        /* Apply theme variables to general elements */
        .bg-gray-800 { background-color: var(--bg-secondary); }
        .bg-gray-700 { background-color: var(--bg-tertiary); }
        .bg-gray-900 { background-color: var(--bg-secondary); } /* Nav and some backgrounds */
        .text-gray-100 { color: var(--text-primary); }
        .text-gray-200 { color: var(--text-primary); }
        .text-gray-300 { color: var(--text-secondary); }
        .text-gray-400 { color: var(--text-secondary); }
        .text-gray-600 { color: var(--text-secondary); } /* For borders */
        .border-gray-600 { border-color: var(--border-color); }
        .border-gray-700 { border-color: var(--border-color); }

        .nav-button, .mode-button {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .nav-button:hover, .mode-button:hover {
            background-color: var(--border-color);
        }
        .nav-button.active {
            background-color: var(--border-color);
        }

        .mode-button.active-mode {
            background-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--accent-blue);
        }

        #xp-bar-outer { background-color: var(--bg-secondary); }
        #xp-bar-fill { background-color: var(--xp-fill-color); }
        #xp-info { color: var(--text-primary); } /* Text over XP bar */
        #level-display { color: var(--text-secondary); } /* Level title */
        #cash-display { color: var(--accent-green); } /* Cash color */

        /* Specific element color overrides for theme */
        #stopwatch-display { color: var(--accent-blue); }
        #pomodoro-timer-display { color: var(--accent-green); }
        .bg-blue-500 { background-color: var(--accent-blue); }
        .bg-yellow-500 { background-color: var(--accent-yellow); }
        .bg-red-500 { background-color: var(--accent-red); }
        .bg-green-500 { background-color: var(--accent-green); }
        .bg-indigo-500 { background-color: var(--accent-purple); }
        /* Add hover styles for new buttons based on var */
        .bg-blue-500:hover { background-color: color-mix(in srgb, var(--accent-blue) 80%, black); }
        .bg-yellow-500:hover { background-color: color-mix(in srgb, var(--accent-yellow) 80%, black); }
        .bg-red-500:hover { background-color: color-mix(in srgb, var(--accent-red) 80%, black); }
        .bg-green-500:hover { background-color: color-mix(in srgb, var(--accent-green) 80%, black); }
        .bg-indigo-500:hover { background-color: color-mix(in srgb, var(--accent-purple) 80%, black); }

        /* Notepad box backgrounds */
        #notepad-section .box-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        #notepad-section .checklist-box { background-color: var(--bg-tertiary); border-color: var(--accent-blue); }
        #notepad-section .notes-box { background-color: var(--bg-tertiary); border-color: var(--accent-green); }
        #notepad-section .goals-box { background-color: var(--bg-tertiary); border-color: var(--accent-purple); }
        #notepad-section .resources-box { background-color: var(--bg-tertiary); border-color: var(--accent-red); }

        /* Shop section styles */
        .shop-skin-card {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }
        .shop-skin-card.locked {
            filter: grayscale(0.8) brightness(0.7);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .shop-skin-card.current-skin {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--accent-blue);
        }
        .shop-skin-card button {
            background-color: var(--accent-blue);
            color: var(--text-primary);
        }
        .shop-skin-card button:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--accent-blue) 80%, black);
        }
        .shop-skin-card button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }


        /* Scrollbar styling */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Custom scrollbar for better visibility */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
            border: 2px solid var(--bg-secondary);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-secondary);
        }

        /* Apply custom-scrollbar to relevant containers */
        #checklist-items-container,
        #notes-list-container,
        #resources-container,
        #goals-container,
        #study-log-entries,
        #chat-window,
        #shop-skins-container,
        #investment-list-container,
        #page-editor-textarea, /* No longer used but kept for safety */
        #page-preview { /* No longer used but kept for safety */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 500px;
            color: var(--text-primary);
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            line-height: 1;
        }

        /* Checklist specific styling */
        .checklist-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .checklist-item input[type="checkbox"] {
            min-width: 1.25rem;
            min-height: 1.25rem;
            cursor: pointer;
        }

        /* Goal item styling */
        .goal-item {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            background-color: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .goal-item:last-child {
            border-bottom: none;
        }
        .goal-item.completed span.goal-text,
        .goal-item.completed span.goal-description {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .goal-item input[type="checkbox"] {
            min-width: 1.25rem;
            min-height: 1.25rem;
            cursor: pointer;
        }
        .goal-item .due-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: auto;
        }
        .goal-item .priority-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: var(--bg-primary); /* dark text for tags, contrast with tag background */
        }
        .priority-tag.low { background-color: var(--accent-yellow); }
        .priority-tag.medium { background-color: var(--accent-blue); color: white;} /* White text for contrast */
        .priority-tag.high { background-color: var(--accent-red); color: white;} /* White text for contrast */
        .goal-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            width: 100%;
            margin-top: 0.25rem;
            padding-left: calc(1.25rem + 0.75rem);
        }

        /* Resource item styling */
        .resource-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .resource-item:last-child {
            border-bottom: none;
        }
        .resource-item a {
            color: var(--accent-blue);
            text-decoration: none;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .resource-item a:hover {
            text-decoration: underline;
        }
        /* Note item styling */
        .note-item {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .note-item:last-child {
            border-bottom: none;
        }

        /* Tab content transition for fluidity */
        .tab-content {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .tab-content.active {
            opacity: 1;
            transform: translateY(0);
            position: static;
            pointer-events: auto;
        }
        /* Ensure specific sections are relative to their parent for absolute positioning of content */
        #main-tracker-section, #notepad-section, #shop-section, #capitalist-section, #about-section, #ai-assistant-section {
            min-height: 500px;
            box-sizing: border-box;
        }
        /* Confetti animation */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: transparent; /* Will be set by JS */
            border-radius: 50%;
            opacity: 0;
            animation: fallAndFade 2s forwards ease-out;
        }

        @keyframes fallAndFade {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) rotate(var(--rotate, 720deg));
            }
        }

        /* Floating Text for XP/Cash gain */
        .floating-text {
            position: absolute;
            font-weight: bold;
            animation: floatAndFade 1.5s forwards ease-out;
            pointer-events: none;
            white-space: nowrap;
            z-index: 10;
        }

        @keyframes floatAndFade {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Desktop specific adjustments for About/Coming Soon */
        @media (min-width: 1024px) { /* lg breakpoint */
            #about-section .text-center > p,
            #about-section .text-center ul,
            #about-section .coming-soon-content,
            #about-section .sponsor-content {
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
                text-align: left;
            }
            #about-section .text-center {
                text-align: center;
            }
        }
        /* Sponsor section specific styles (Fixed colors as requested) */
        .sponsor-card {
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #cc0000;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 600px;
            width: 100%;
        }
        @media (min-width: 768px) {
            .sponsor-card {
                flex-direction: row;
                gap: 2.5rem;
                max-width: 800px;
            }
        }
        .sponsor-card hr {
            border-color: #cc0000;
            width: 80%;
            margin: 1rem auto;
        }
        @media (min-width: 768px) {
            .sponsor-card hr {
                display: none;
            }
            .sponsor-card::before {
                content: '';
                position: absolute;
                left: 50%;
                top: 10%;
                bottom: 10%;
                width: 2px;
                background-color: #cc0000;
                transform: translateX(-50%);
            }
        }
        .sponsor-title-ar, .sponsor-text-ar {
            color: #ffffff;
        }
        .sponsor-title-en, .sponsor-text-en {
            color: #ffffff;
        }
        .sponsor-highlight-ar, .sponsor-highlight-en {
            color: #cc0000;
            font-weight: bold;
        }

        /* AI Assistant specific styles */
        #chat-window {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        .chat-message {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .user-message {
            background-color: var(--accent-blue);
            color: white;
        }
        .ai-message {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .spinner {
            border-top: 4px solid var(--accent-blue);
        }
        #gemini-api-key-input, #user-input, #session-name-input, #pomodoro-study-mins-input, #pomodoro-short-break-mins-input, #pomodoro-long-break-mins-input, #ambient-sound-selector, #new-checklist-item-input, #new-note-title-input, #new-note-content-input, #new-goal-name-input, #new-goal-description-input, #new-goal-priority-input, #new-goal-due-date-input, #new-resource-title-input, #new-resource-url-input, #edit-session-name, #edit-duration, #wake-up-hour-input, #wake-up-ampm-input, #bed-hour-input, #bed-ampm-input, #investment-amount-input, #investment-type-select, #investment-duration-select {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        /* Shop skin card specific styling for preview */
        .shop-skin-preview {
            width: 100px;
            height: 60px;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .shop-skin-preview.default-dark {
            background: linear-gradient(45deg, #1a202c, #2d3748);
        }
        .shop-skin-preview.default-light {
            background: linear-gradient(45deg, #f0f4f8, #e2e8f0);
        }
        .shop-skin-preview.forest-dream {
            background: linear-gradient(45deg, #1e3a24, #2d5736);
        }
        .shop-skin-preview.ocean-breeze {
            background: linear-gradient(45deg, #0a1f2e, #1a3a54);
        }
        .shop-skin-preview.midnight-violet {
            background: linear-gradient(45deg, #210a30, #3b1b52);
        }

        /* Capitalist Game Styles */
        .investment-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .investment-card .progress-bar {
            background-color: var(--bg-secondary);
        }
        .investment-card .progress-fill {
            background-color: var(--accent-blue);
        }
        .investment-card.matured {
            border-color: var(--accent-green);
        }
        .investment-card.lost {
            border-color: var(--accent-red);
        }

    </style>
</head>
<body class="default-dark-skin flex flex-col items-center min-h-screen">

    <!-- Navigation Bar -->
    <nav class="w-full p-4 shadow-lg flex justify-center space-x-4 flex-wrap" style="background-color: var(--bg-secondary);">
        <button id="nav-study-tracker" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            Study Tracker
        </button>
        <button id="nav-notepad" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            Notepad
        </button>
        <button id="nav-shop" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            Shop
        </button>
        <button id="nav-capitalist" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            Capitalist
        </button>
        <button id="nav-about" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            About
        </button>
        <button id="nav-ai-assistant" class="nav-button font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out mb-2 lg:mb-0">
            AI Study Assistant
        </button>
    </nav>


    <!-- Main Content Area for Tabs -->
    <div class="flex flex-col items-center justify-center flex-grow p-4 w-full">

        <!-- Study Tracker Section (Tab Content) -->
        <div id="main-tracker-section" class="relative w-full max-w-6xl rounded-2xl shadow-xl flex flex-col lg:flex-row p-6 space-y-8 lg:space-y-0 lg:space-x-8 tab-content" style="background-color: var(--bg-secondary);">

            <!-- Main Study Timer Area (Stopwatch/Pomodoro/Stats Switch) -->
            <div class="flex-1 flex flex-col items-center p-4">
                <h1 class="text-4xl font-bold mb-4 text-gray-100">Study Tracker</h1>

                <!-- XP Bar & Cash Wrapper (New Layout) -->
                <div id="xp-cash-wrapper" class="flex items-center justify-between w-full max-w-xl mb-4">
                    <div id="level-display" class="text-sm font-bold text-gray-200 mr-2 min-w-[100px] text-left"></div>
                    <div id="xp-bar-outer" class="flex-grow rounded-full h-2.5 overflow-hidden shadow-inner relative">
                        <div id="xp-bar-fill" class="h-full rounded-full transition-all duration-500 ease-in-out"></div>
                        <div id="xp-info" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-100"></div>
                    </div>
                    <div id="cash-display" class="text-sm font-bold ml-2 min-w-[70px] text-right"></div>
                </div>

                <!-- Mode Selector -->
                <div class="flex justify-center gap-4 mb-8 mt-4">
                    <button id="mode-stopwatch-btn" class="mode-button font-bold py-2 px-6 rounded-full transition duration-300 ease-in-out">
                        Stopwatch
                    </button>
                    <button id="mode-pomodoro-btn" class="mode-button font-bold py-2 px-6 rounded-full transition duration-300 ease-in-out">
                        Pomodoro
                    </button>
                    <button id="mode-stats-sub" class="mode-button font-bold py-2 px-6 rounded-full transition duration-300 ease-in-out">
                        Stats
                    </button>
                </div>

                <!-- Stopwatch View -->
                <div id="stopwatch-view" class="w-full flex flex-col items-center">
                    <!-- Stopwatch Display -->
                    <div id="stopwatch-display" class="text-8xl font-extrabold mb-8 select-none">
                        00 min 00 s
                    </div>

                    <!-- Session Naming Input -->
                    <div class="w-full flex justify-center mb-4">
                        <input type="text" id="session-name-input" placeholder="Enter session name (optional)"
                               class="p-3 rounded-full border focus:outline-none focus:ring-2 focus:ring-blue-500 w-full max-w-md">
                    </div>

                    <!-- Stopwatch Controls -->
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        <button id="start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                            Start (S)
                        </button>
                        <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300 hidden">
                            Stop (P)
                        </button>
                        <button id="add-to-log-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300" disabled>
                            Add to Log (L)
                        </button>
                    </div>
                </div>

                <!-- Pomodoro View -->
                <div id="pomodoro-view" class="w-full flex flex-col items-center hidden">
                    <div class="text-3xl font-semibold mb-2 text-gray-300" id="pomodoro-phase-display">Study Time</div>
                    <div class="text-xl font-bold mb-4 text-gray-400" id="pomodoro-cycle-counter">Pomodoro #0</div>
                    <div id="pomodoro-timer-display" class="text-8xl font-extrabold mb-8 select-none">
                        25:00
                    </div>
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        <button id="pomodoro-start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                            Start (S)
                        </button>
                        <button id="pomodoro-pause-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300 hidden">
                            Pause (P)
                        </button>
                        <button id="pomodoro-reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                            Reset (R)
                        </button>
                        <button id="pomodoro-skip-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                            Skip (K)
                        </button>
                    </div>

                    <!-- Pomodoro Settings Toggle Button -->
                    <button id="toggle-pomodoro-settings-btn" class="font-bold py-2 px-4 rounded-full shadow transition duration-300 ease-in-out mt-4 focus:outline-none focus:ring-2 focus:ring-gray-500" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">
                        Customize Pomodoro
                    </button>

                    <!-- Pomodoro Settings (Initially hidden) -->
                    <div id="pomodoro-settings" class="mt-6 w-full max-w-md p-4 rounded-lg shadow-inner text-center hidden" style="background-color: var(--bg-tertiary);">
                        <h3 class="text-xl font-semibold mb-3 text-gray-100">Pomodoro Settings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="pomodoro-study-mins-input" class="block text-sm font-medium text-gray-300">Study (min)</label>
                                <input type="number" id="pomodoro-study-mins-input" value="25" min="1" max="120"
                                       class="w-full p-2 rounded-md border focus:outline-none focus:ring-2 focus:ring-green-500 text-center">
                            </div>
                            <div>
                                <label for="pomodoro-short-break-mins-input" class="block text-sm font-medium text-gray-300">Short Break (min)</label>
                                <input type="number" id="pomodoro-short-break-mins-input" value="5" min="1" max="30"
                                       class="w-full p-2 rounded-md border focus:outline-none focus:ring-2 focus:ring-yellow-500 text-center">
                            </div>
                            <div>
                                <label for="pomodoro-long-break-mins-input" class="block text-sm font-medium text-gray-300">Long Break (min)</label>
                                <input type="number" id="pomodoro-long-break-mins-input" value="15" min="1" max="60"
                                       class="w-full p-2 rounded-md border focus:outline-none focus:ring-2 focus:ring-red-500 text-center">
                            </div>
                        </div>
                        <!-- Ambient Sound Mixer (Updated) -->
                        <div class="flex items-center justify-center mb-4">
                            <label for="ambient-sound-selector" class="text-gray-300 text-sm mr-2">Ambient Sound:</label>
                            <select id="ambient-sound-selector" class="p-2 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="none">None</option>
                                <option value="rain">Rain</option>
                                <option value="cafe">Cafe</option>
                                <option value="ocean">Ocean Waves</option>
                                <option value="forest">Forest</option>
                            </select>
                            <input type="range" id="ambient-volume-slider" min="0" max="1" step="0.1" value="0.3" class="ml-4 w-24 accent-blue-500">
                        </div>
                        <button id="save-pomodoro-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-md transition duration-300 ease-in-out">
                            Save Settings
                        </button>
                    </div>
                </div>

                <!-- Stats View (New Sub-Tab Content) -->
                <div id="stats-view" class="w-full flex flex-col items-center hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-100">Your Study Statistics</h2>
                    <!-- Stats Display -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 w-full">
                        <div class="bg-blue-700 p-4 rounded-xl shadow text-center">
                            <p class="text-sm font-semibold text-blue-100">Today's Study</p>
                            <p id="stat-today" class="text-2xl font-bold text-white mt-1">0 min</p>
                        </div>
                        <div class="bg-green-700 p-4 rounded-xl shadow text-center">
                            <p class="text-sm font-semibold text-green-100">Total Study</p>
                            <p id="stat-overall" class="text-2xl font-bold text-white mt-1">0 min</p>
                        </div>
                        <div class="bg-purple-700 p-4 rounded-xl shadow text-center">
                            <p class="text-sm font-semibold text-purple-100">Daily Goal Completion</p>
                            <p id="stat-daily-goal" class="text-2xl font-bold text-white mt-1">0%</p>
                        </div>
                    </div>
                </div>

                <!-- Set Daily Goal Button (remains in main tracker section) -->
                <div class="absolute bottom-4 left-4">
                    <button id="set-daily-goal-btn" class="font-bold py-2 px-4 rounded-full shadow transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">
                        Set Daily Goal
                    </button>
                </div>
            </div>

            <!-- Study Log Section -->
            <div class="lg:w-1/3 p-4 rounded-xl shadow-inner flex flex-col" style="background-color: var(--bg-tertiary);">
                <h2 class="text-2xl font-bold mb-4 text-gray-100 text-center">Study Log</h2>
                <div class="flex justify-center gap-2 mb-4">
                    <button id="prev-log-btn" class="font-bold py-1 px-3 rounded-full transition duration-300 ease-in-out" style="background-color: var(--border-color); color: var(--text-secondary);">
                        &larr; Prev
                    </button>
                    <button id="next-log-btn" class="font-bold py-1 px-3 rounded-full transition duration-300 ease-in-out" style="background-color: var(--border-color); color: var(--text-secondary);">
                        Next &rarr;
                    </button>
                </div>
                <div id="study-log-entries" class="flex-grow overflow-y-auto custom-scrollbar space-y-6 p-2 max-h-96">
                    <!-- Log entries will be inserted here by JavaScript -->
                    <p class="text-gray-300 text-center">No sessions logged yet.</p>
                </div>
                <button id="clear-log-btn" class="mt-4 font-bold py-2 px-4 rounded-full shadow transition duration-300 ease-in-out" style="background-color: var(--border-color); color: var(--text-secondary);">
                    Clear All Sessions
                </button>
            </div>
        </div>

        <!-- Daily Focus Container (New Position) -->
        <div id="daily-focus-container" class="mt-8 p-6 rounded-xl shadow-lg w-full max-w-6xl text-center" style="background-color: var(--bg-secondary);">
            <h3 class="text-xl font-semibold text-gray-100 mb-3">Daily Inspiration ?</h3>
            <p id="daily-focus-text" class="text-gray-300 italic mb-4">Click "Get New Tip" for a fresh dose of motivation or a quick study hack!</p>
            <button id="get-daily-focus-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-full shadow transition duration-300 ease-in-out">
                Get New Quote
            </button>
        </div>


        <!-- Notepad Section (Tab Content) -->
        <div id="notepad-section" class="w-full max-w-6xl rounded-2xl shadow-xl p-6 mt-8 mb-8 hidden tab-content" style="background-color: var(--bg-secondary);">
            <h2 class="text-3xl font-bold mb-6 text-gray-100 text-center">My Notepad ??</h2>
            <div class="grid grid-cols-1 gap-6"> <!-- Changed to single column grid -->

                <!-- Checklist Box -->
                <div class="box-container checklist-box">
                    <h3 class="text-xl font-semibold mb-3 text-gray-100 flex items-center">Checklist ?</h3>
                    <div class="flex mb-4 gap-2">
                        <input type="text" id="new-checklist-item-input" placeholder="Add new checklist item"
                               class="flex-grow p-2 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-checklist-item-btn"
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Add Item
                        </button>
                    </div>
                    <div id="checklist-items-container" class="flex-grow space-y-2 custom-scrollbar p-2" style="max-height: 250px;">
                        <!-- Checklist items will be rendered here -->
                    </div>
                </div>

                <!-- Quick Notes Box -->
                <div class="box-container notes-box">
                    <h3 class="text-xl font-semibold mb-3 text-gray-100 flex items-center">Quick Notes ??</h3>
                    <div class="flex flex-col gap-3 mb-4">
                        <input type="text" id="new-note-title-input" placeholder="Note Title"
                               class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <textarea id="new-note-content-input" placeholder="Note Content"
                                  class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"></textarea>
                        <button id="add-note-btn"
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Add Note
                        </button>
                    </div>
                    <div id="notes-list-container" class="flex-grow space-y-2 custom-scrollbar p-2" style="max-height: 250px;">
                        <!-- Individual notes will be rendered here -->
                        <p class="text-gray-400 text-center text-sm">No notes added yet.</p>
                    </div>
                </div>

                <!-- Goals & Planning Section (Moved up) -->
                <div class="box-container goals-box">
                    <h3 class="text-xl font-semibold mb-3 text-gray-100 flex items-center">My Study Goals & Planning ??</h3>
                    <div class="mb-6">
                        <div class="flex flex-col gap-4 mb-4">
                            <input type="text" id="new-goal-name-input" placeholder="Goal Name (e.g., Finish Chapter 3)"
                                   class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                            <textarea id="new-goal-description-input" placeholder="Description (optional, e.g., Read pages 50-75 and do exercises)"
                                      class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 w-full min-h-[60px]"></textarea>
                            <div class="flex flex-col md:flex-row gap-4 w-full">
                                <select id="new-goal-priority-input"
                                        class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">
                                    <option value="Low">Low Priority</option>
                                    <option value="Medium" selected>Medium Priority</option>
                                    <option value="High">High Priority</option>
                                </select>
                                <input type="date" id="new-goal-due-date-input"
                                       class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">
                                <button id="add-goal-btn"
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out">
                                    Add Goal
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="goals-container" class="space-y-3 custom-scrollbar p-2" style="max-height: 250px;">
                        <!-- Goals will be rendered here -->
                        <p class="text-gray-400 text-center text-sm">No goals added yet.</p>
                    </div>
                </div>

                <!-- Resources Section -->
                <div class="box-container resources-box">
                    <h3 class="text-xl font-semibold mb-3 text-gray-100 flex items-center">My Resources & Links ??</h3>
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <input type="text" id="new-resource-title-input" placeholder="Resource Title"
                                   class="flex-grow p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="url" id="new-resource-url-input" placeholder="Resource URL (e.g., https://example.com)"
                                   class="flex-grow p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="add-resource-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out">
                                Add Resource
                            </button>
                        </div>
                    </div>
                    <div id="resources-container" class="space-y-3 custom-scrollbar p-2" style="max-height: 250px;">
                        <!-- Resources will be rendered here -->
                        <p class="text-gray-400 text-center text-sm">No resources added yet.</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Shop Section (New Tab Content) -->
        <div id="shop-section" class="w-full max-w-6xl rounded-2xl shadow-xl p-6 mt-8 mb-8 hidden tab-content" style="background-color: var(--bg-secondary);">
            <h2 class="text-3xl font-bold mb-6 text-gray-100 text-center">The StudyFlow Shop ???</h2>
            <p class="text-gray-300 text-center mb-6">Level up your study environment! Purchase new visual themes for your tracker.</p>

            <div id="shop-skins-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar p-2 max-h-[600px]">
                <!-- Skins will be rendered here by JavaScript -->
                <p class="text-gray-400 text-center text-sm col-span-full">Shop loading...</p>
            </div>
        </div>

        <!-- Capitalist Game Section (NEW TAB) -->
        <div id="capitalist-section" class="w-full max-w-6xl rounded-2xl shadow-xl p-6 mt-8 mb-8 hidden tab-content" style="background-color: var(--bg-secondary);">
            <h2 class="text-3xl font-bold mb-6 text-gray-100 text-center">StudyFlow Capitalist ??</h2>
            <p class="text-gray-300 text-center mb-6">Invest your hard-earned cash to generate more money over time. The higher your level, the more lucrative (and risky!) your options become.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Make Investment Card -->
                <div class="investment-card p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Make an Investment</h3>
                    <div class="mb-4">
                        <label for="investment-amount-input" class="block text-sm font-medium mb-1 text-gray-300">Amount to Invest ($)</label>
                        <input type="number" id="investment-amount-input" min="10" value="100"
                               class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                    </div>
                    <div class="mb-4">
                        <label for="investment-type-select" class="block text-sm font-medium mb-1 text-gray-300">Investment Type</label>
                        <select id="investment-type-select" class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                            <option value="bond">Study Bond</option>
                            <option value="venture">Study Venture</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="investment-duration-select" class="block text-sm font-medium mb-1 text-gray-300">Duration</label>
                        <select id="investment-duration-select" class="p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                            <option value="3600000">1 Hour</option>
                            <option value="21600000">6 Hours</option>
                            <option value="86400000">24 Hours</option>
                        </select>
                    </div>
                    <button id="invest-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out w-full">
                        Invest!
                    </button>
                </div>

                <!-- Active Investments Display -->
                <div class="investment-card p-6 rounded-xl shadow-lg flex flex-col">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Your Active Investments</h3>
                    <div id="investment-list-container" class="flex-grow custom-scrollbar space-y-4 p-2 max-h-96">
                        <p class="text-gray-400 text-center text-sm">No active investments.</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- About Section (Tab Content) -->
        <div id="about-section" class="w-full max-w-6xl rounded-2xl shadow-xl p-6 mt-8 mb-8 hidden tab-content" style="background-color: var(--bg-secondary);">
            <h2 class="text-3xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 text-center drop-shadow-lg">
                Unlock Your Potential with StudyFlow ??
            </h2>
            <div class="text-center text-gray-200 leading-relaxed text-lg">
                <p class="mb-6 animate-fade-in">
                    Welcome to <strong>StudyFlow</strong>, your dedicated digital partner crafted to revolutionize how you study and manage your time. We believe that effective learning shouldn't be a struggle, but a fluid, engaging journey. That's why we've built an intuitive platform to empower students and lifelong learners alike!
                </p>
                <h3 class="text-2xl font-bold text-green-400 mb-4 animate-slide-up">Why Choose StudyFlow?</h3>
                <ul class="list-disc list-inside text-left mx-auto max-w-md mt-2 space-y-3 text-gray-300">
                    <li class="flex items-start mb-2">
                        <span class="text-xl mr-3">?</span>
                        <div><strong>Effortless Organization:</strong> Consolidate your study sessions, set ambitious goals, and curate essential resources  all within a single, streamlined workspace.</div>
                    </li>
                    <li class="flex items-start mb-2">
                        <span class="text-xl mr-3">??</span>
                        <div><strong>Boost Your Focus Power:</strong> Harness the renowned Pomodoro Technique to slice your study time into focused, manageable sprints, amplifying concentration and banishing burnout.</div>
                    </li>
                    <li class="flex items-start mb-2">
                        <span class="text-xl mr-3">??</span>
                        <div><strong>Track Your Triumphs:</strong> Visualize your daily and cumulative study hours to uncover valuable insights into your habits, celebrate every milestone, and watch your progress soar!</div>
                    </li>
                    <li class="flex items-start mb-2">
                        <span class="text-xl mr-3">??</span>
                        <div><strong>Conquer Procrastination:</strong> With clear objectives and real-time tracking, you'll feel an undeniable surge of motivation, turning procrastination into consistent, rewarding progress.</div>
                    </li>
                </ul>
                <p class="font-bold text-white mt-8 text-xl animate-fade-in-slow">
                    <span class="text-red-400">Your Privacy, Our Promise:</span> A Fortress of Security ??
                    <br>At StudyFlow, your digital safety is not just a feature  it's our foundational principle. We operate with unwavering transparency and profound respect for your personal information. Every byte of data you generate within this application  from your study logs to your most private notes, goals, and resources  is stored <strong class="text-yellow-300">exclusively within your browser's local storage</strong>. This means:
                </p>
                <ul class="list-disc list-inside text-left mx-auto max-w-md mt-4 space-y-2 text-gray-300">
                    <li class="flex items-start"><span class="text-red-400 text-lg mr-2">?</span> We absolutely do <strong class="text-white">NOT</strong> collect any personal data.</li>
                    <li class="flex items-start"><span class="text-red-400 text-lg mr-2">?</span> Your valuable information is <strong class="text-white">NEVER</strong> stored on our servers.</li>
                    <li class="flex items-start"><span class="text-red-400 text-lg mr-2">?</span> We are committed to a strict <strong class="text-white">NO</strong> data scraping policy.</li>
                </ul>
                <p class="mt-8 text-xl font-semibold text-purple-300 animate-bounce-in">
                    Embark on a secure, efficient, and truly empowering study experience! Join the StudyFlow revolution today! ??
                </p>
            </div>

            <!-- Coming Soon Section -->
            <div class="coming-soon-content text-left text-gray-200 leading-relaxed text-lg space-y-6 mt-12 pt-8 border-t" style="border-color: var(--border-color);">
                <h2 class="text-3xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 text-center drop-shadow-lg">
                    The Future of StudyFlow is Brighter Than Ever! ??
                </h2>
                <p class="mb-6">We're relentlessly innovating to bring you a more powerful and personalized StudyFlow experience. Get ready for these groundbreaking enhancements hitting your browser soon:</p>

                <div class="flex items-start mb-4">
                    <span class="text-3xl mr-4 text-blue-400">??</span>
                    <div>
                        <h3 class="text-2xl font-bold mb-2 text-blue-400"><strong>Advanced Analytics & Visual Mastery</strong></h3>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-gray-300">
                            <li><strong>Interactive Performance Charts:</strong> Dive deep into your study patterns with dynamic graphs illustrating your progress across days, weeks, and months. Pinpoint your peak productivity and areas for growth!</li>
                            <li><strong>Comprehensive Productivity Reports:</strong> Receive insightful summaries of your study sessions, track your goal completion rates, and analyze your average focus durations to fine-tune your learning strategy.</li>
                        </ul>
                    </div>
                </div>

                <div class="flex items-start mb-4">
                    <span class="text-3xl mr-4 text-purple-400">??</span>
                    <div>
                        <h3 class="text-2xl font-bold mb-2 text-purple-400"><strong>Intelligent Notifications & Gentle Nudges</strong></h3>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-gray-300">
                            <li><strong>Goal Guardian Reminders:</strong> Get timely, smart notifications if you're drifting away from your daily study targets, keeping you on track effortlessly.</li>
                            <li><strong>Mindful Break Prompts:</strong> Receive gentle nudges to step away and recharge during marathon study sessions, ensuring sustainable productivity.</li>
                        </ul>
                    </div>
                </div>

                <div class="flex items-start mb-4">
                    <span class="text-3xl mr-4 text-yellow-400">??</span>
                    <div>
                        <h3 class="text-2xl font-bold mb-2 text-yellow-400"><strong>Unleash Your Style: Themes & Personalization</strong></h3>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-gray-300">
                            <li><strong>Radiant Light Mode:</strong> Toggle seamlessly between our classic dark theme and a brand-new, vibrant light mode designed for ultimate visual comfort.</li>
                            <li><strong>Custom Color Palettes:</strong> Express yourself! Choose from an expansive spectrum of color schemes to tailor the StudyFlow interface to your unique aesthetic.</li>
                        </ul>
                    </div>
                </div>

                <div class="flex items-start mb-4">
                    <span class="text-3xl mr-4 text-red-400">??</span>
                    <div>
                        <h3 class="text-2xl font-bold mb-2 text-red-400"><strong>Master Your Data: Advanced Management Tools</strong></h3>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-gray-300">
                            <li><strong>Effortless Data Backup:</strong> Securely export all your study sessions, notes, goals, and resources as a portable JSON file. Your data is truly yours!</li>
                            <li><strong>Seamless Data Import:</strong> Restore your entire StudyFlow universe in seconds by importing your previously exported JSON files.</li>
                        </ul>
                    </div>
                </div>

                <div class="flex items-start mb-4">
                    <span class="text-3xl mr-4 text-teal-400">??</span>
                    <div>
                        <h3 class="text-2xl font-bold mb-2 text-teal-400"><strong>Ignite Your Journey: Engaging Gamification</strong></h3>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-gray-300">
                            <li><strong>Achievements & Exclusive Badges:</strong> Earn dazzling virtual rewards as you crush study milestones and maintain unwavering consistency.</li>
                            <li><strong>Epic Study Streaks:</strong> Build and track your consecutive study days, transforming your routine into a thrilling quest for knowledge and self-improvement!</li>
                        </ul>
                    </div>
                </div>

                <p class="text-center font-extrabold text-white mt-10 text-xl animate-pulse">
                    The future of focused learning is here. Stay tuned for these transformative updates and many more, empowering you to master your study routine like never before! ??????
                </p>
            </div>

            <!-- Sponsor Section (Redesigned with Red, Black, White) -->
            <div class="sponsor-content text-gray-300 leading-relaxed text-lg flex flex-col items-center mt-12 pt-8 border-t" style="border-color: var(--border-color);">
                <h2 class="text-3xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-white to-red-600 text-center drop-shadow-lg">
                    Our Valued Sponsor: A Partnership in Progress ??
                </h2>
                <div class="sponsor-card relative">
                    <div class="left-side">
                        <p class="sponsor-highlight-en text-5xl font-extrabold mb-2">
                            Al-Taqwa Company
                        </p>
                        <p class="sponsor-text-en text-2xl">
                            for Food Delivery
                        </p>
                    </div>
                    <hr class="border-red-600 my-4"> <!-- Horizontal rule for mobile -->
                    <div class="right-side">
                        <p class="sponsor-highlight-ar text-5xl font-extrabold mb-2" dir="rtl">
                            ???? ??????
                        </p>
                        <p class="sponsor-text-ar text-2xl" dir="rtl">
                            ??????? ?????????
                        </p>
                    </div>
                </div>
                <p class="mt-6 text-xl text-white font-semibold">
                    We extend our deepest gratitude for their unwavering support in fueling our mission!
                </p>
            </div>
        </div>


        <!-- AI Assistant Section (New Tab Content) -->
        <div id="ai-assistant-section" class="w-full max-w-6xl rounded-2xl shadow-xl p-6 mt-8 mb-8 hidden tab-content" style="background-color: var(--bg-secondary);">
            <h2 class="text-3xl font-bold mb-6 text-gray-100 text-center">AI Study Assistant ??</h2>
            <div id="chat-window" class="w-full h-96 overflow-y-auto custom-scrollbar mb-4">
                <div class="ai-message">
                    <p>Hello! I'm your AI Study Assistant. I can help you with study tips, explain concepts, provide motivation, or just chat. What's on my mind today?</p>
                </div>
            </div>
            <div id="loading-indicator" class="loading-indicator hidden">
                <div class="spinner"></div>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="user-input" placeholder="Ask me anything..."
                       class="flex-grow p-3 rounded-full border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-chat-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out">
                    Send
                </button>
            </div>
            <!-- API Key Input for AI Assistant -->
            <div class="mt-4 p-4 rounded-lg shadow-inner border border-red-500" style="background-color: var(--bg-tertiary);">
                <h3 class="text-xl font-semibold mb-3 text-gray-100 flex items-center">
                    <span class="text-red-400 text-2xl mr-2">??</span> Gemini API Key Required
                </h3>
                <p class="text-sm text-gray-300 mb-3">
                    To use the AI Assistant, you **must** provide your own Gemini API key.
                    You can generate a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 underline hover:text-blue-300">Google AI Studio</a>.
                    Your key will be securely saved only in your browser's local storage.
                </p>
                <div class="flex gap-2">
                    <input type="password" id="gemini-api-key-input" placeholder="Enter your Gemini API Key here..."
                           class="flex-grow p-3 rounded-md border focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="save-api-key-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-md transition duration-300 ease-in-out">
                        Save API Key
                    </button>
                </div>
                <button id="clear-api-key-btn" class="mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                    Clear API Key
                </button>
            </div>
        </div>
    </div>


    <!-- Custom Confirmation/Alert Modal -->
    <div id="custom-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="custom-modal-close-btn">&times;</button>
            <h3 id="custom-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="custom-modal-message" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="custom-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out hidden">
                    Cancel
                </button>
                <button id="custom-modal-confirm-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    OK
                </button>
            </div>
        </div>
    </div>


    <!-- Edit Session Modal -->
    <div id="edit-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="edit-modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-gray-100">Edit Study Session</h2>
            <div class="mb-4">
                <label for="edit-session-name" class="block text-sm font-medium mb-1 text-gray-300">Session Name</label>
                <input type="text" id="edit-session-name"
                       class="p-2 rounded-md border w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label for="edit-duration" class="block text-sm font-medium mb-1 text-gray-300">Duration (minutes)</label>
                <input type="number" id="edit-duration"
                       class="p-2 rounded-md border w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Cancel
                </button>
                <button id="save-edit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Goal Setting Modal -->
    <div id="goal-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="goal-modal-close-btn">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-gray-100">Set Daily Study Goal</h2>
            <p class="text-sm text-gray-300 mb-4">
                Based on your wake-up and bedtime, we'll calculate 60% of your awake time as a daily study target.
            </p>
            <div class="mb-4 flex items-center gap-2">
                <label for="wake-up-hour-input" class="block text-sm font-medium text-gray-300">Wake-up Time:</label>
                <select id="wake-up-hour-input" class="p-2 rounded-md border w-20"></select>
                <select id="wake-up-ampm-input" class="p-2 rounded-md border w-20">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                </select>
            </div>
            <div class="mb-4 flex items-center gap-2">
                <label for="bed-hour-input" class="block text-sm font-medium text-gray-300">Bedtime:</label>
                <select id="bed-hour-input" class="p-2 rounded-md border w-20"></select>
                <select id="bed-ampm-input" class="p-2 rounded-md border w-20">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-goal-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Cancel
                </button>
                <button id="save-goal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Save Goal
                </button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const stopwatchDisplay = document.getElementById('stopwatch-display');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const addLogBtn = document.getElementById('add-to-log-btn');
        const studyLogEntries = document.getElementById('study-log-entries');
        // Stats displays are now within stats-view, but elements still used directly
        const statToday = document.getElementById('stat-today');
        const statOverall = document.getElementById('stat-overall');
        const statDailyGoal = document.getElementById('stat-daily-goal');

        const clearLogBtn = document.getElementById('clear-log-btn');
        const sessionNameInput = document.getElementById('session-name-input');
        const setDailyGoalBtn = document.getElementById('set-daily-goal-btn');
        const prevLogBtn = document.getElementById('prev-log-btn');
        const nextLogBtn = document.getElementById('next-log-btn');

        // Mode Switch Buttons (Stopwatch/Pomodoro/Stats)
        const modeStopwatchBtn = document.getElementById('mode-stopwatch-btn');
        const modePomodoroBtn = document.getElementById('mode-pomodoro-btn');
        const modeStatsSubBtn = document.getElementById('mode-stats-sub'); // New sub-tab button for stats

        const stopwatchView = document.getElementById('stopwatch-view');
        const pomodoroView = document.getElementById('pomodoro-view');
        const statsView = document.getElementById('stats-view'); // New stats view div

        // Pomodoro Elements
        const pomodoroTimerDisplay = document.getElementById('pomodoro-timer-display');
        const pomodoroPhaseDisplay = document.getElementById('pomodoro-phase-display');
        const pomodoroCycleCounter = document.getElementById('pomodoro-cycle-counter'); // New cycle counter element
        const pomodoroStartBtn = document.getElementById('pomodoro-start-btn');
        const pomodoroPauseBtn = document.getElementById('pomodoro-pause-btn');
        const pomodoroResetBtn = document.getElementById('pomodoro-reset-btn');
        const pomodoroSkipBtn = document.getElementById('pomodoro-skip-btn');
        const pomodoroStudyMinsInput = document.getElementById('pomodoro-study-mins-input'); // New input
        const pomodoroShortBreakMinsInput = document.getElementById('pomodoro-short-break-mins-input'); // New input
        const pomodoroLongBreakMinsInput = document.getElementById('pomodoro-long-break-mins-input'); // New input
        const savePomodoroSettingsBtn = document.getElementById('save-pomodoro-settings-btn'); // New button
        const togglePomodoroSettingsBtn = document.getElementById('toggle-pomodoro-settings-btn'); // New button for settings toggle
        const pomodoroSettings = document.getElementById('pomodoro-settings'); // Settings div

        // Ambient Sound Mixer (Updated)
        const ambientSoundSelector = document.getElementById('ambient-sound-selector');
        const ambientVolumeSlider = document.getElementById('ambient-volume-slider');


        // Navigation and Tab elements (top-level)
        const navStudyTracker = document.getElementById('nav-study-tracker');
        const navNotepad = document.getElementById('nav-notepad');
        const navShop = document.getElementById('nav-shop'); // NEW
        const navCapitalist = document.getElementById('nav-capitalist'); // NEW
        const navAbout = document.getElementById('nav-about');
        const navAIAssistant = document.getElementById('nav-ai-assistant');

        const notepadSection = document.getElementById('notepad-section');
        const mainTrackerSection = document.getElementById('main-tracker-section');
        const shopSection = document.getElementById('shop-section'); // NEW
        const capitalistSection = document.getElementById('capitalist-section'); // NEW
        const aboutSection = document.getElementById('about-section');
        const aiAssistantSection = document.getElementById('ai-assistant-section');


        // XP Bar Elements (Updated to include wrapper)
        const xpCashWrapper = document.getElementById('xp-cash-wrapper'); // New wrapper element
        const levelDisplay = document.getElementById('level-display'); // New element for level
        const xpBarOuter = document.getElementById('xp-bar-outer'); // Renamed from xp-bar-container
        const xpBarFill = document.getElementById('xp-bar-fill');
        const xpInfo = document.getElementById('xp-info');
        const cashDisplay = document.getElementById('cash-display'); // New element for cash


        // Notepad elements
        const newChecklistItemInput = document.getElementById('new-checklist-item-input');
        const addChecklistItemBtn = document.getElementById('add-checklist-item-btn');
        const checklistItemsContainer = document.getElementById('checklist-items-container');
        const newNoteTitleInput = document.getElementById('new-note-title-input');
        const newNoteContentInput = document.getElementById('new-note-content-input');
        const addNoteBtn = document.getElementById('add-note-btn');
        const notesListContainer = document.getElementById('notes-list-container');

        // Notepad's moved Resources elements
        const newResourceTitleInput = document.getElementById('new-resource-title-input');
        const newResourceUrlInput = document.getElementById('new-resource-url-input');
        const addResourceBtn = document.getElementById('add-resource-btn');
        const resourcesContainer = document.getElementById('resources-container');

        // Notepad's moved Goals elements
        const newGoalNameInput = document.getElementById('new-goal-name-input');
        const newGoalDescriptionInput = document.getElementById('new-goal-description-input');
        const newGoalPriorityInput = document.getElementById('new-goal-priority-input');
        const newGoalDueDateInput = document.getElementById('new-goal-due-date-input');
        const addGoalBtn = document.getElementById('add-goal-btn');
        const goalsContainer = document.getElementById('goals-container');


        // Edit Session Modal Elements
        const editModalOverlay = document.getElementById('edit-modal-overlay');
        const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
        const editSessionNameInput = document.getElementById('edit-session-name');
        const editDurationInput = document.getElementById('edit-duration');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');

        // Goal Modal Elements
        const goalModalOverlay = document.getElementById('goal-modal-overlay');
        const goalModalCloseBtn = document.getElementById('goal-modal-close-btn');
        const wakeUpHourInput = document.getElementById('wake-up-hour-input');
        const wakeUpAmpmInput = document.getElementById('wake-up-ampm-input');
        const bedHourInput = document.getElementById('bed-hour-input');
        const bedAmpmInput = document.getElementById('bed-ampm-input');
        const cancelGoalBtn = document.getElementById('cancel-goal-btn');
        const saveGoalBtn = document.getElementById('save-goal-btn');

        // Custom Modal Elements
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const customModalCloseBtn = document.getElementById('custom-modal-close-btn');
        const customModalTitle = document.getElementById('custom-modal-title');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalCancelBtn = document.getElementById('custom-modal-cancel-btn');
        const customModalConfirmBtn = document.getElementById('custom-modal-confirm-btn');

        // AI Assistant Elements
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const clearApiKeyBtn = document.getElementById('clear-api-key-btn');


        // Daily Focus Elements
        const dailyFocusContainer = document.getElementById('daily-focus-container');
        const dailyFocusText = document.getElementById('daily-focus-text');
        const getDailyFocusBtn = document.getElementById('get-daily-focus-btn');

        // Shop Elements (NEW)
        const shopSkinsContainer = document.getElementById('shop-skins-container');

        // Capitalist Game Elements (NEW)
        const investmentAmountInput = document.getElementById('investment-amount-input');
        const investmentTypeSelect = document.getElementById('investment-type-select');
        const investmentDurationSelect = document.getElementById('investment-duration-select');
        const investBtn = document.getElementById('invest-btn');
        const investmentListContainer = document.getElementById('investment-list-container');


        // Stopwatch Variables
        let startTime = 0;
        let elapsedTime = 0;
        let timerInterval = null;
        let isRunning = false;
        let currentSessionStartTime = null; // Track start time of current continuous session for logging

        // Pomodoro Variables
        let pomodoroStudyTime = 25 * 60 * 1000; // 25 minutes in ms, now customizable
        let pomodoroShortBreakTime = 5 * 60 * 1000; // 5 minutes in ms, now customizable
        let pomodoroLongBreakTime = 15 * 60 * 1000; // 15 minutes in ms, now customizable
        const POMODORO_CYCLES_FOR_LONG_BREAK = 4;

        let pomodoroCurrentTime = pomodoroStudyTime;
        let pomodoroTimerId = null;
        let pomodoroIsRunning = false;
        let pomodoroPhase = 'study'; // 'study', 'shortBreak', 'longBreak'
        let pomodoroCycleCount = 0; // Number of study sessions completed
        let pomodoroSessionStartTime = 0; // The actual start time of the current *study* session being tracked by Pomodoro.

        // Audio for notifications
        const notificationSound = new Audio('https://www.soundjay.com/buttons/beep-07.mp3'); // A simple beep sound
        // Ambient sound setup (Updated)
        const ambientSoundsMap = {
            none: null,
            rain: 'https://www.soundjay.com/nature/sounds/rain-02.mp3',
            cafe: 'https://www.soundjay.com/miscellaneous/sounds/cafe-01.mp3',
            ocean: 'https://www.soundjay.com/nature/sounds/ocean-waves-01.mp3',
            forest: 'https://www.soundjay.com/nature/sounds/forest-ambience-01.mp3'
        };
        let ambientAudio = new Audio();
        ambientAudio.loop = true;


        // Current display mode for the main tracker: 'stopwatch', 'pomodoro', or 'stats'
        let currentDisplayMode = 'stopwatch';


        // Data Storage
        let studySessions = [];
        let totalStudyTodayMs = 0;
        let totalStudyOverallMs = 0;
        let dailyStudyGoalMs = 0;
        let checklistItems = [];
        let individualNotes = []; // New array for individual notes
        let studyResources = [];
        let studyGoals = [];
        let investments = []; // NEW: For StudyFlow Capitalist game

        // Level System Variables
        let currentXP = 0;
        let currentLevel = 1;
        let xpToNextLevel = 100; // Initial XP to reach Level 1

        const LEVEL_TITLES = {
            1: "Rookie",
            5: "Apprentice",
            10: "Novice",
            15: "Practitioner",
            20: "Journeyman",
            25: "Scholar",
            30: "Expert",
            35: "Adept",
            40: "Master",
            45: "Grandmaster",
            50: "Legend",
            55: "Oracle",
            60: "Sage",
            65: "Virtuoso",
            70: "Luminary",
            75: "Ascendant",
            80: "Enlightened",
            85: "Omniscient",
            90: "Transcendent",
            95: "Divine",
            100: "Architect of Knowledge"
        };

        // Cash System Variable (New)
        let currentCash = 0;
        const CASH_PER_MINUTE_BASE = 20; // Reverted to a less aggressive value
        const CASH_MULTIPLIER_MIN = 1.0; // Keep random factor for study
        const CASH_MULTIPLIER_MAX = 1.3; // Keep random factor for study

        // XP System Variables
        const XP_PER_MINUTE_BASE = 1; // Reverted to a less aggressive value (higher than previous 0.5)

        // API Key for AI Assistant (Now explicitly managed by user input only)
        let geminiApiKey = "";


        // Currently edited session ID
        let currentEditingSessionId = null;

        // Log navigation variables
        let currentLogScrollPosition = 0;
        const logEntryHeight = 110;

        // AI Chat history
        let chatHistory = [{ role: "model", parts: [{ text: "Hello! I'm your AI Study Assistant. I can help you with study tips, explain concepts, provide motivation, or just chat. What's on my mind today?" }] }];

        // Hardcoded Daily Focus Famous Quotes (20+ new ones)
        const dailyTips = [
            "\"The only way to do great work is to love what you do.\"  Steve Jobs",
            "\"Believe you can and you're halfway there.\"  Theodore Roosevelt",
            "\"The future belongs to those who believe in the beauty of their dreams.\"  Eleanor Roosevelt",
            "\"Strive not to be a success, but rather to be of value.\"  Albert Einstein",
            "\"The mind is everything. What you think you become.\"  Buddha",
            "\"The best way to predict the future is to create it.\"  Peter Drucker",
            "\"Success is not final, failure is not fatal: it is the courage to continue that counts.\"  Winston S. Churchill",
            "\"The only limit to our realization of tomorrow will be our doubts of today.\"  Franklin D. Roosevelt",
            "\"It always seems impossible until it's done.\"  Nelson Mandela",
            "\"Education is the most powerful weapon which you can use to change the world.\"  Nelson Mandela",
            "\"Learning is not attained by chance; it must be sought for with ardor and attended to with diligence.\"  Abigail Adams",
            "\"The beautiful thing about learning is that no one can take it away from you.\"  B.B. King",
            "\"I find that the harder I work, the more luck I seem to have.\"  Thomas Jefferson",
            "\"Setting goals is the first step in turning the invisible into the visible.\"  Tony Robbins",
            "\"Patience is a key element of success.\"  Bill Gates",
            "\"You don't have to be great to start, but you have to start to be great.\"  Zig Ziglar",
            "\"The expert in anything was once a beginner.\"  Helen Hayes",
            "\"It does not matter how slowly you go as long as you do not stop.\"  Confucius",
            "\"Our greatest weakness lies in giving up. The most certain way to succeed is always to try just one more time.\"  Thomas A. Edison",
            "\"The foundation of every state is the education of its youth.\"  Diogenes Laertius",
            "\"Study hard what interests you the most in the most undisciplined, irreverent and original manner possible.\"  Richard Feynman",
            "\"Success is the sum of small efforts repeated day in and day out.\"  Robert Collier",
            "\"The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.\"  Brian Herbert",
            "\"Don't wish it were easier, wish you were better.\"  Jim Rohn"
        ];
        let currentTipIndex = 0;

        // Skin Management
        const skins = [
            { id: 'default-dark', name: 'Default Dark', type: 'dark', levelRequired: 0, cost: 0, bodyClass: 'default-dark-skin', unlocked: true },
            { id: 'default-light', name: 'Default Light', type: 'light', levelRequired: 0, cost: 0, bodyClass: 'default-light-skin', unlocked: true },
            { id: 'forest-dream', name: 'Forest Dream', type: 'dark', levelRequired: 5, cost: 2000, bodyClass: 'forest-dream-skin', unlocked: false },
            { id: 'ocean-breeze', name: 'Ocean Breeze', type: 'dark', levelRequired: 10, cost: 5000, bodyClass: 'ocean-breeze-skin', unlocked: false },
            { id: 'midnight-violet', name: 'Midnight Violet', type: 'dark', levelRequired: 15, cost: 10000, bodyClass: 'midnight-violet-skin', unlocked: false }
        ];
        let activeSkinId = 'default-dark';


        // --- Custom Modal Functions ---
        let resolveCustomModalPromise;

        /**
         * Displays a custom alert/confirmation modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         * @param {boolean} isConfirm - If true, displays a cancel button for confirmation.
         * @returns {Promise<boolean>} Resolves to true for OK/Confirm, false for Cancel.
         */
        function showCustomModal(title, message, isConfirm = false) {
            customModalTitle.innerHTML = title; // Use innerHTML for rich content
            customModalMessage.innerHTML = message; // Use innerHTML for rich content
            customModalCancelBtn.classList.toggle('hidden', !isConfirm);
            customModalOverlay.classList.remove('hidden');

            return new Promise((resolve) => {
                resolveCustomModalPromise = resolve;

                customModalConfirmBtn.onclick = () => {
                    customModalOverlay.classList.add('hidden');
                    resolve(true);
                };

                customModalCancelBtn.onclick = () => {
                    customModalOverlay.classList.add('hidden');
                    resolve(false);
                };

                customModalCloseBtn.onclick = () => {
                    customModalOverlay.classList.add('hidden');
                    resolve(false); // Treat closing as cancellation for confirm modals
                };
            });
        }


        // --- Utility Functions ---

        /**
         * Generates a unique ID.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return crypto.randomUUID();
        }

        /**
         * Formats milliseconds into a human-readable string (e.g., "88 min 7 s").
         * @param {number} ms - The time in milliseconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds} s`;
        }

        /**
         * Formats milliseconds into a MM:SS string.
         * @param {number} ms - The time in milliseconds.
         * @returns {string} Formatted time string (MM:SS).
         */
        function formatMinutesSeconds(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Formats a Date object into a readable time string (e.g., "HH:MM AM/PM").
         * @param {Date} date - The Date object.
         * @returns {string} Formatted time string.
         */
        function formatDateTime(date) {
            const options = { hour: 'numeric', minute: 'numeric', hour12: true };
            return date.toLocaleString('en-US', options);
        }

        /**
         * Converts hours and AM/PM to minutes from midnight (24-hour format).
         * @param {string} hour - Hour (1-12).
         * @param {string} ampm - "AM" or "PM".
         * @returns {number} Minutes from midnight.
         */
        function hourAmpmToMinutes(hour, ampm) {
            let h = parseInt(hour, 10);
            if (ampm === 'PM' && h !== 12) {
                h += 12;
            } else if (ampm === 'AM' && h === 12) {
                h = 0; // 12 AM is 00 hours
            }
            return h * 60; // We only deal with hours, no minutes for input.
        }

        /**
         * Calculates the daily study target based on wake-up and bedtime.
         * @param {string} wakeHour - Wake-up hour (1-12).
         * @param {string} wakeAmpm - Wake-up AM/PM.
         * @param {string} bedHour - Bedtime hour (1-12).
         * @param {string} bedAmpm - Bedtime AM/PM.
         * @returns {number} Daily study goal in milliseconds.
         */
        function calculateDailyTargetMs(wakeHour, wakeAmpm, bedHour, bedAmpm) {
            if (!wakeHour || !wakeAmpm || !bedHour || !bedAmpm) return 0;

            const wakeMinutes = hourAmpmToMinutes(wakeHour, wakeAmpm);
            const bedMinutes = hourAmpmToMinutes(bedHour, bedAmpm);

            let awakeDurationMinutes;
            if (bedMinutes > wakeMinutes) {
                awakeDurationMinutes = bedMinutes - wakeMinutes;
            } else {
                // Spans across midnight (e.g., wake 10 PM, bed 6 AM)
                awakeDurationMinutes = (24 * 60 - wakeMinutes) + bedMinutes;
            }

            const targetMinutes = Math.round(awakeDurationMinutes * 0.60);

            return targetMinutes * 60 * 1000; // Convert to milliseconds
        }

        /**
         * Triggers a confetti animation.
         * @param {HTMLElement} targetElement - The element around which confetti will appear.
         */
        function triggerConfetti(targetElement) {
            const colors = ['#f6e05e', '#63b3ed', '#fc8181', '#9f7aea', '#48bb78']; // Yellow, Blue, Red, Purple, Green
            const numConfetti = 20; // Number of confetti pieces

            const rect = targetElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${centerX}px`;
                confetti.style.top = `${centerY}px`;

                // Randomize trajectory
                const angle = Math.random() * Math.PI * 2; // Full circle
                const distance = Math.random() * 100 + 50; // 50-150px
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                const rotation = Math.random() * 720; // Up to 2 full rotations

                confetti.style.setProperty('--x', `${x}px`);
                confetti.style.setProperty('--y', `${y}px`);
                confetti.style.setProperty('--rotate', `${rotation}deg`);

                document.body.appendChild(confetti);

                // Remove confetti after animation to clean up DOM
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        /**
         * Displays a floating text animation for XP/Cash gain.
         * @param {HTMLElement} originElement - The element from which the text appears to float.
         * @param {string} text - The text to display (e.g., "+$200", "+5 XP").
         * @param {string} color - The CSS color for the text.
         */
        function showFloatingText(originElement, text, color) {
            const rect = originElement.getBoundingClientRect();
            const floatingDiv = document.createElement('div');
            floatingDiv.textContent = text;
            floatingDiv.className = 'floating-text';
            floatingDiv.style.color = color;
            floatingDiv.style.left = `${rect.left + rect.width / 2}px`;
            floatingDiv.style.top = `${rect.top}px`; // Start just above the element
            floatingDiv.style.transform = 'translateX(-50%)'; // Center horizontally

            document.body.appendChild(floatingDiv);

            floatingDiv.addEventListener('animationend', () => {
                floatingDiv.remove();
            });
        }

        /**
         * Converts a basic Markdown-like syntax to HTML.
         * Supports headings, bold, italic, lists, links, images, and code blocks.
         * @param {string} text - The input text with Markdown.
         * @returns {string} The HTML formatted text.
         */
        function formatTextWithMarkdown(text) {
            let formattedText = text;

            // Headings
            formattedText = formattedText.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            formattedText = formattedText.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            formattedText = formattedText.replace(/^# (.*$)/gm, '<h1>$1</h1>');

            // Bold: **text**
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic: *text*
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Links: [text](url)
            formattedText = formattedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

            // Images: ![alt](url)
            formattedText = formattedText.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" onerror="this.onerror=null;this.src=\'https://placehold.co/150x100/374151/E2E8F0?text=Image Error\';">');


            // Unordered Lists: - item or * item
            formattedText = formattedText.replace(/^\s*[-*]\s+(.*)$/gm, '<li>$1</li>');
            formattedText = formattedText.replace(/(<li>.*<\/li>(\s*<li>.*<\/li>)*)/g, '<ul>$1</ul>');

            // Ordered Lists: 1. item
            formattedText = formattedText.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');
            formattedText = formattedText.replace(/(<li>.*<\/li>(\s*<li>.*<\/li>)*)/g, '<ol>$1</ol>');


            // Code blocks: ```language\ncode\n```
            // This is a simplified regex. A full markdown parser would be more robust.
            formattedText = formattedText.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Inline code: `code`
            formattedText = formattedText.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Newlines to <br> for regular text paragraphs
            formattedText = formattedText.split('\n').map(line => {
                // Don't add <br> within already processed block-level elements
                if (line.trim().startsWith('<h') || line.trim().startsWith('<ul') || line.trim().startsWith('<ol') || line.trim().startsWith('<pre') || line.trim() === '') {
                    return line;
                }
                return line + '<br>';
            }).join('');


            return formattedText;
        }

        /**
         * Saves data to localStorage.
         */
        function saveToLocalStorage() {
            localStorage.setItem('studySessions', JSON.stringify(studySessions));
            localStorage.setItem('totalStudyTodayMs', totalStudyTodayMs);
            localStorage.setItem('totalStudyOverallMs', totalStudyOverallMs);
            localStorage.setItem('dailyStudyGoalMs', dailyStudyGoalMs);
            localStorage.setItem('wakeUpHour', wakeUpHourInput.value);
            localStorage.setItem('wakeUpAmpm', wakeUpAmpmInput.value);
            localStorage.setItem('bedHour', bedHourInput.value);
            localStorage.setItem('bedAmpm', bedAmpmInput.value);
            localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
            localStorage.setItem('individualNotes', JSON.stringify(individualNotes));
            localStorage.setItem('studyResources', JSON.stringify(studyResources));
            localStorage.setItem('studyGoals', JSON.stringify(studyGoals));

            // Save Pomodoro settings
            localStorage.setItem('pomodoroStudyTime', pomodoroStudyMinsInput.value);
            localStorage.setItem('pomodoroShortBreakTime', pomodoroShortBreakMinsInput.value);
            localStorage.setItem('pomodoroLongBreakTime', pomodoroLongBreakMinsInput.value);
            localStorage.setItem('ambientSoundSelected', ambientSoundSelector.value);
            localStorage.setItem('ambientVolume', ambientVolumeSlider.value);

            // Save Level System data
            localStorage.setItem('currentXP', currentXP);
            localStorage.setItem('currentLevel', currentLevel);
            localStorage.setItem('xpToNextLevel', xpToNextLevel);
            localStorage.setItem('currentCash', currentCash);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            localStorage.setItem('geminiApiKey', geminiApiKey); // Save the API key

            // Save Shop data
            localStorage.setItem('skins', JSON.stringify(skins));
            localStorage.setItem('activeSkinId', activeSkinId);

            // Save Investments data (NEW)
            localStorage.setItem('investments', JSON.stringify(investments));
        }

        /**
         * Loads data from localStorage. Handles data migration from old keys.
         */
        function loadFromLocalStorage() {
            const storedSessions = localStorage.getItem('studySessions');
            const storedTotalToday = localStorage.getItem('totalStudyTodayMs');
            const storedTotalOverall = localStorage.getItem('totalStudyOverallMs');
            const storedDailyGoal = localStorage.getItem('dailyStudyGoalMs');
            const storedWakeHour = localStorage.getItem('wakeUpHour');
            const storedWakeAmpm = localStorage.getItem('wakeUpAmpm');
            const storedBedHour = localStorage.getItem('bedHour');
            const storedBedAmpm = localStorage.getItem('bedAmpm');
            const storedChecklistItems = localStorage.getItem('checklistItems');
            const storedIndividualNotes = localStorage.getItem('individualNotes');

            // Load Pomodoro settings
            const storedPomodoroStudyTime = localStorage.getItem('pomodoroStudyTime');
            const storedPomodoroShortBreakTime = localStorage.getItem('pomodoroShortBreakTime');
            const storedPomodoroLongBreakTime = localStorage.getItem('pomodoroLongBreakTime');
            const storedAmbientSoundSelected = localStorage.getItem('ambientSoundSelected');
            const storedAmbientVolume = localStorage.getItem('ambientVolume');

            // Load Level System data
            const storedCurrentXP = localStorage.getItem('currentXP');
            const storedCurrentLevel = localStorage.getItem('currentLevel');
            const storedXpToNextLevel = localStorage.getItem('xpToNextLevel');
            const storedCurrentCash = localStorage.getItem('currentCash');
            const storedChatHistory = localStorage.getItem('chatHistory');
            const storedGeminiApiKey = localStorage.getItem('geminiApiKey');

            // Load Shop data
            const storedSkins = localStorage.getItem('skins');
            const storedActiveSkinId = localStorage.getItem('activeSkinId');

            // Load Investments data (NEW)
            const storedInvestments = localStorage.getItem('investments');


            if (storedSessions) {
                studySessions = JSON.parse(storedSessions);
            }
            if (storedTotalToday) {
                totalStudyTodayMs = parseInt(storedTotalToday, 10);
            }
            if (storedTotalOverall) {
                totalStudyOverallMs = parseInt(storedTotalOverall, 10);
            }
            if (storedDailyGoal) {
                dailyStudyGoalMs = parseInt(storedDailyGoal, 10);
            }
            if (storedWakeHour) {
                wakeUpHourInput.value = storedWakeHour;
            }
            if (storedWakeAmpm) {
                wakeUpAmpmInput.value = storedWakeAmpm;
            }
            if (storedBedHour) {
                bedHourInput.value = storedBedHour;
            }
            if (storedBedAmpm) {
                bedAmpmInput.value = storedBedAmpm;
            }
            if (storedChecklistItems) {
                checklistItems = JSON.parse(storedChecklistItems);
            }
            if (storedIndividualNotes) {
                individualNotes = JSON.parse(storedIndividualNotes);
            }

            // Load Resources and Goals (they are already in correct places, no specific migration needed from old code)
            const storedResources = localStorage.getItem('studyResources');
            if (storedResources) {
                try {
                    studyResources = JSON.parse(storedResources);
                } catch (e) {
                    console.error("Error parsing resources data, resetting:", e);
                    studyResources = [];
                }
            }
            const storedGoals = localStorage.getItem('studyGoals');
            if (storedGoals) {
                try {
                    studyGoals = JSON.parse(storedGoals);
                } catch (e) {
                    console.error("Error parsing goals data, resetting:", e);
                    studyGoals = [];
                }
            }

            // Apply loaded Pomodoro settings
            if (storedPomodoroStudyTime) {
                pomodoroStudyMinsInput.value = storedPomodoroStudyTime;
                pomodoroStudyTime = parseInt(storedPomodoroStudyTime, 10) * 60 * 1000;
            }
            if (storedPomodoroShortBreakTime) {
                pomodoroShortBreakMinsInput.value = storedPomodoroShortBreakTime;
                pomodoroShortBreakTime = parseInt(storedPomodoroShortBreakTime, 10) * 60 * 1000;
            }
            if (storedPomodoroLongBreakTime) {
                pomodoroLongBreakMinsInput.value = storedPomodoroLongBreakTime;
                pomodoroLongBreakTime = parseInt(storedPomodoroLongBreakTime, 10) * 60 * 1000;
            }
            if (storedAmbientSoundSelected) {
                ambientSoundSelector.value = storedAmbientSoundSelected;
            }
            if (storedAmbientVolume) {
                ambientAudio.volume = parseFloat(storedAmbientVolume);
                ambientVolumeSlider.value = storedAmbientVolume;
            } else {
                ambientAudio.volume = 0.3; // Default volume
                ambientVolumeSlider.value = 0.3;
            }
            // Set initial src for ambientAudio based on loaded selection
            ambientAudio.src = ambientSoundsMap[ambientSoundSelector.value] || '';
            ambientAudio.load();


            // Apply loaded Level System data
            if (storedCurrentXP) {
                currentXP = parseInt(storedCurrentXP, 10);
            }
            if (storedCurrentLevel) {
                currentLevel = parseInt(storedCurrentLevel, 10);
            }
            if (storedXpToNextLevel) {
                xpToNextLevel = parseInt(storedXpToNextLevel, 10);
            } else {
                xpToNextLevel = calculateXPForNextLevel(currentLevel);
            }
            if (storedCurrentCash) {
                currentCash = parseInt(storedCurrentCash, 10);
            }
            if (storedChatHistory) {
                chatHistory = JSON.parse(storedChatHistory);
            }
            // API key is now strictly from input field, not loaded from localStorage by default
            geminiApiKey = storedGeminiApiKey || ""; // Load if exists, but init value is ""
            geminiApiKeyInput.value = geminiApiKey; // Display loaded key, if any


            // Load and merge skins data (Handles new skins and their unlocked status)
            if (storedSkins) {
                const loadedSkins = JSON.parse(storedSkins);
                skins.forEach(defaultSkin => {
                    const loaded = loadedSkins.find(s => s.id === defaultSkin.id);
                    if (loaded) {
                        defaultSkin.unlocked = loaded.unlocked;
                        // Ensure other properties like levelRequired, cost, bodyClass are from default to prevent tampering
                    }
                });
            }

            if (storedActiveSkinId) {
                activeSkinId = storedActiveSkinId;
                applySkin(activeSkinId, false); // Apply without saving again, to avoid loop
            } else {
                applySkin('default-dark', false); // Ensure default-dark is applied if nothing found
            }

            // Load Investments data (NEW)
            if (storedInvestments) {
                investments = JSON.parse(storedInvestments);
            }


            const todayDate = new Date().toDateString();
            const sessionsToday = studySessions.filter(session => new Date(session.endTime).toDateString() === todayDate);

            if (sessionsToday.length === 0) {
                totalStudyTodayMs = 0;
            } else {
                totalStudyTodayMs = sessionsToday.reduce((sum, session) => sum + session.durationMs, 0);
            }

            renderStats();
            renderLog();
            renderChecklist();
            renderIndividualNotes();
            renderResources(); // Render resources inside notepad
            renderGoals(); // Render goals inside notepad
            updateXPBar();
            renderCash();
            renderChatHistory();
            renderShop(); // Render shop on load
            renderInvestments(); // NEW: Render investments on load
        }

        /**
         * Recalculates all statistics based on the current studySessions array.
         */
        function recalculateStats() {
            totalStudyOverallMs = 0;
            totalStudyTodayMs = 0;

            const todayDate = new Date().toDateString();

            studySessions.forEach(session => {
                totalStudyOverallMs += session.durationMs;
                if (new Date(session.endTime).toDateString() === todayDate) {
                    totalStudyTodayMs += session.durationMs;
                }
            });

            renderStats();
            saveToLocalStorage();
        }

        /**
         * Updates the stopwatch display with the current elapsed time.
         */
        function updateStopwatchDisplay() {
            const currentTime = Date.now();
            const currentElapsed = currentTime - startTime + elapsedTime;
            stopwatchDisplay.textContent = formatTime(currentElapsed);
        }

        /**
         * Renders all study sessions in the log section.
         */
        function renderLog() {
            studyLogEntries.innerHTML = ''; // Clear existing entries
            if (studySessions.length === 0) {
                studyLogEntries.innerHTML = '<p class="text-gray-300 text-center">No sessions logged yet.</p>';
                return;
            }

            const sortedSessions = [...studySessions].sort((a, b) => new Date(b.endTime) - new Date(a.endTime));

            sortedSessions.forEach((session) => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'bg-gray-800 p-4 rounded-xl shadow-md';
                sessionDiv.innerHTML = `
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <span class="font-semibold text-gray-100 truncate">${session.name || 'Untitled'}</span>
                        <span class="text-gray-200 text-sm font-bold">${formatTime(session.durationMs)}</span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-400 mt-1">
                        <span>${formatDateTime(new Date(session.startTime))} - ${formatDateTime(new Date(session.endTime))}</span>
                        <div class="flex space-x-2">
                            <button class="edit-session-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${session.id}">
                                Edit
                            </button>
                            <button class="delete-session-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${session.id}">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                studyLogEntries.appendChild(sessionDiv);
            });

            // Attach event listeners for edit/delete buttons
            document.querySelectorAll('.edit-session-btn').forEach(button => {
                button.addEventListener('click', (event) => openEditModal(event.target.dataset.id));
            });
            document.querySelectorAll('.delete-session-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteSession(event.target.dataset.id));
            });
        }

        /**
         * Updates the statistics display.
         */
        function renderStats() {
            statToday.textContent = formatTime(totalStudyTodayMs);
            statOverall.textContent = formatTime(totalStudyOverallMs);

            if (dailyStudyGoalMs > 0) {
                const completionPercentage = Math.min(100, Math.round((totalStudyTodayMs / dailyStudyGoalMs) * 100));
                statDailyGoal.textContent = `${completionPercentage}%`;
            } else {
                statDailyGoal.textContent = `N/A`;
            }
        }

        /**
         * Clears all study sessions and statistics.
         */
        async function clearAllSessions() {
            const confirmed = await showCustomModal(
                'Clear All Sessions',
                'Are you sure you want to clear all study sessions? This cannot be undone.',
                true // isConfirm = true
            );
            if (confirmed) {
                studySessions = [];
                recalculateStats();
                renderLog();
                // Reset XP, level, and cash on clearing all sessions
                currentXP = 0;
                currentLevel = 1;
                xpToNextLevel = calculateXPForNextLevel(currentLevel);
                currentCash = 0;
                updateXPBar();
                renderCash();
                saveToLocalStorage();
            }
        }

        /**
         * Deletes a session by its ID.
         * @param {string} id - The ID of the session to delete.
         */
        async function deleteSession(id) {
            const confirmed = await showCustomModal(
                'Delete Session',
                'Are you sure you want to delete this session?',
                true // isConfirm = true
            );
            if (confirmed) {
                const index = studySessions.findIndex(session => session.id === id);
                if (index !== -1) {
                    const session = studySessions[index];
                    // Deduct XP if session is deleted
                    const xpDeducted = Math.floor(session.durationMs / (1000 * 60)) * XP_PER_MINUTE_BASE;
                    currentXP = Math.max(0, currentXP - xpDeducted);
                    updateLevel(); // Recalculate level after XP change

                    // Deduct cash if session is deleted
                    // Note: Cash deduction here is based on base rate, not original random multiplier for simplicity on deletion
                    const cashDeducted = Math.floor(session.durationMs / (1000 * 60)) * CASH_PER_MINUTE_BASE;
                    currentCash = Math.max(0, currentCash - cashDeducted);
                    renderCash();

                    studySessions.splice(index, 1);
                    recalculateStats();
                    renderLog();
                }
            }
        }

        /**
         * Opens the edit session modal.
         * @param {string} id - The ID of the session to edit.
         */
        function openEditModal(id) {
            currentEditingSessionId = id;
            const session = studySessions.find(s => s.id === id);
            if (session) {
                editSessionNameInput.value = session.name || '';
                editDurationInput.value = Math.floor(session.durationMs / (1000 * 60));
                editModalOverlay.classList.remove('hidden');
            }
        }

        /**
         * Closes the edit session modal.
         */
        function closeEditModal() {
            editModalOverlay.classList.add('hidden');
            currentEditingSessionId = null;
        }

        /**
         * Saves changes from the edit session modal.
         */
        async function saveEditedSession() {
            if (!currentEditingSessionId) return;

            const sessionIndex = studySessions.findIndex(s => s.id === currentEditingSessionId);
            if (sessionIndex !== -1) {
                const oldDurationMs = studySessions[sessionIndex].durationMs;
                const newName = editSessionNameInput.value.trim();
                const newDurationMinutes = parseInt(editDurationInput.value, 10);

                if (isNaN(newDurationMinutes) || newDurationMinutes < 0) {
                    await showCustomModal('Invalid Input', "Please enter a valid duration in minutes (a non-negative number).");
                    return;
                }

                const newDurationMs = newDurationMinutes * 60 * 1000;

                studySessions[sessionIndex].name = newName;
                studySessions[sessionIndex].durationMs = newDurationMs;

                // Adjust XP based on duration change
                const oldXP = Math.floor(oldDurationMs / (1000 * 60)) * XP_PER_MINUTE_BASE;
                const newXP = Math.floor(newDurationMs / (1000 * 60)) * XP_PER_MINUTE_BASE;
                currentXP += (newXP - oldXP);
                currentXP = Math.max(0, currentXP); // Ensure XP doesn't go below zero
                updateLevel(); // Recalculate level after XP change

                // Adjust cash based on duration change
                const oldCash = Math.floor(oldDurationMs / (1000 * 60)) * CASH_PER_MINUTE_BASE; // Base rate
                const newCash = Math.floor(newDurationMs / (1000 * 60)) * CASH_PER_MINUTE_BASE; // Base rate
                currentCash += (newCash - oldCash);
                currentCash = Math.max(0, currentCash);
                renderCash();

                recalculateStats();
                renderLog();
                closeEditModal();
            }
        }

        /**
         * Populates hour dropdowns for goal setting.
         */
        function populateHourDropdowns() {
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString();
                wakeUpHourInput.appendChild(option);

                const bedOption = document.createElement('option');
                bedOption.value = i.toString().padStart(2, '0');
                bedOption.textContent = i.toString();
                bedHourInput.appendChild(bedOption);
            }
        }

        /**
         * Opens the goal setting modal.
         */
        function openGoalModal() {
            // Set defaults or loaded values
            wakeUpHourInput.value = localStorage.getItem('wakeUpHour') || '08';
            wakeUpAmpmInput.value = localStorage.getItem('wakeUpAmpm') || 'AM';
            bedHourInput.value = localStorage.getItem('bedHour') || '11';
            bedAmpmInput.value = localStorage.getItem('bedAmpm') || 'PM';
            goalModalOverlay.classList.remove('hidden');
        }

        /**
         * Closes the goal setting modal.
         */
        function closeGoalModal() {
            goalModalOverlay.classList.add('hidden');
        }

        /**
         * Saves wake-up and bedtime, then recalculates the daily goal.
         */
        async function saveGoalTimes() {
            const wakeHour = wakeUpHourInput.value;
            const wakeAmpm = wakeUpAmpmInput.value;
            const bedHour = bedHourInput.value;
            const bedAmpm = bedAmpmInput.value;

            if (!wakeHour || !wakeAmpm || !bedHour || !bedAmpm) {
                await showCustomModal('Missing Information', "Please select both wake-up time (hour and AM/PM) and bedtime (hour and AM/PM).");
                return;
            }

            dailyStudyGoalMs = calculateDailyTargetMs(wakeHour, wakeAmpm, bedHour, bedAmpm);
            localStorage.setItem('hasSetGoal', 'true');
            saveToLocalStorage();
            renderStats();
            closeGoalModal();
        }

        // --- Stopwatch Functions ---

        /**
         * Sets the state of control buttons (visible/hidden and disabled) and input fields for Stopwatch mode.
         */
        function setStopwatchButtonStates() {
            if (isRunning) {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                addLogBtn.disabled = false;
                sessionNameInput.disabled = true;
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                addLogBtn.disabled = (elapsedTime === 0);
                sessionNameInput.disabled = false;
            }
        }

        /**
         * Starts the stopwatch.
         */
        function startTimer() {
            if (isRunning) return;

            isRunning = true;
            startTime = Date.now();
            if (elapsedTime === 0) {
                currentSessionStartTime = startTime;
            }

            timerInterval = setInterval(() => {
                const current = Date.now();
                const totalCurrentElapsed = current - startTime + elapsedTime;
                stopwatchDisplay.textContent = formatTime(totalCurrentElapsed);
            }, 1000);

            setStopwatchButtonStates();
        }

        /**
         * Stops the stopwatch.
         */
        function stopTimer() {
            if (!isRunning) return;

            isRunning = false;
            clearInterval(timerInterval);
            elapsedTime += Date.now() - startTime;

            setStopwatchButtonStates();
        }

        /**
         * Adds the current stopwatch session to the study log.
         * Resets the stopwatch after logging.
         */
        function addSessionToLog() {
            if (isRunning) {
                stopTimer();
            }

            if (elapsedTime === 0) return;

            const sessionStartTime = currentSessionStartTime || (Date.now() - elapsedTime);
            const sessionEndTime = Date.now();
            const sessionDurationMs = elapsedTime;
            const sessionName = sessionNameInput.value.trim() || 'Untitled Session';

            const newSession = {
                id: generateUniqueId(),
                name: sessionName,
                startTime: sessionStartTime,
                endTime: sessionEndTime,
                durationMs: sessionDurationMs,
            };
            studySessions.push(newSession);

            // Grant XP for the session duration (0.5 XP per minute)
            const xpGained = Math.floor(sessionDurationMs / (1000 * 60)) * XP_PER_MINUTE_BASE;
            currentXP += xpGained;
            updateLevel(); // Check for level up
            if (xpGained > 0) {
                showFloatingText(xpInfo, `+${Math.floor(xpGained)} XP`, getComputedStyle(document.documentElement).getPropertyValue('--xp-fill-color'));
            }

            // Grant cash for the session duration with random multiplier
            const cashMultiplier = Math.random() * (CASH_MULTIPLIER_MAX - CASH_MULTIPLIER_MIN) + CASH_MULTIPLIER_MIN;
            const cashGained = Math.floor(Math.floor(sessionDurationMs / (1000 * 60)) * CASH_PER_MINUTE_BASE * cashMultiplier);
            currentCash += cashGained;
            renderCash();
            if (cashGained > 0) {
                showFloatingText(cashDisplay, `+$${cashGained}`, getComputedStyle(document.documentElement).getPropertyValue('--accent-green'));
            }


            totalStudyOverallMs += sessionDurationMs;
            totalStudyTodayMs += sessionDurationMs;

            saveToLocalStorage();
            recalculateStats();
            renderLog();

            elapsedTime = 0;
            currentSessionStartTime = null;
            stopwatchDisplay.textContent = '00 min 00 s';
            sessionNameInput.value = '';
            setStopwatchButtonStates();
        }

        // --- Pomodoro Timer Functions ---

        /**
         * Updates the Pomodoro display with current time and phase.
         */
        function updatePomodoroDisplay() {
            pomodoroTimerDisplay.textContent = formatMinutesSeconds(pomodoroCurrentTime);
            let phaseText = '';
            let timerColor = '';

            if (pomodoroPhase === 'study') {
                phaseText = 'Study Time';
                timerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
            } else if (pomodoroPhase === 'shortBreak') {
                phaseText = 'Short Break';
                timerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-yellow');
            } else if (pomodoroPhase === 'longBreak') {
                phaseText = 'Long Break';
                timerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-red');
            }
            pomodoroPhaseDisplay.textContent = phaseText;
            pomodoroTimerDisplay.style.color = timerColor;

            pomodoroCycleCounter.textContent = `Pomodoro #${pomodoroCycleCount}`;

            // Update button states
            if (pomodoroIsRunning) {
                pomodoroStartBtn.classList.add('hidden');
                pomodoroPauseBtn.classList.remove('hidden');
            } else {
                pomodoroStartBtn.classList.remove('hidden');
                pomodoroPauseBtn.classList.add('hidden');
            }
        }

        /**
         * Starts the Pomodoro timer.
         */
        function startPomodoroTimer() {
            if (pomodoroIsRunning) return;

            // Attempt to play ambient sound only if selected and not already playing
            updateAmbientSound(); // This will play/pause based on selection and timer state

            pomodoroIsRunning = true;
            pomodoroSessionStartTime = Date.now() - (pomodoroCurrentTime); // Record start time for logging

            pomodoroTimerId = setInterval(() => {
                pomodoroCurrentTime -= 1000;
                if (pomodoroCurrentTime <= 0) {
                    clearInterval(pomodoroTimerId);
                    notificationSound.play(); // Play sound notification
                    if (pomodoroPhase === 'study') {
                        logPomodoroSession(pomodoroStudyTime); // Log the full study duration
                        triggerConfetti(pomodoroTimerDisplay); // Confetti on study session end
                    }
                    pomodoroIsRunning = false; // Stop the timer
                    ambientAudio.pause(); // Pause ambient sound when timer ends naturally

                    // Move to next phase state, but DO NOT start it automatically
                    advancePomodoroPhaseState();
                    updatePomodoroDisplay(); // Update display to show next phase/time, but stopped
                    showCustomModal('Phase Ended!', `Your ${pomodoroPhase === 'study' ? 'study' : 'break'} session has ended. Click Start to begin the next phase.`, false);

                }
                updatePomodoroDisplay();
            }, 1000);
            updatePomodoroDisplay(); // Initial update when started
        }

        /**
         * Pauses the Pomodoro timer.
         */
        function pausePomodoroTimer() {
            if (!pomodoroIsRunning) return;

            pomodoroIsRunning = false;
            clearInterval(pomodoroTimerId);
            ambientAudio.pause(); // Pause ambient sound when timer is paused
            updatePomodoroDisplay();
        }

        /**
         * Resets the Pomodoro timer to initial study phase.
         */
        function resetPomodoroTimer() {
            pausePomodoroTimer();
            pomodoroCurrentTime = pomodoroStudyTime;
            pomodoroPhase = 'study';
            pomodoroCycleCount = 0;
            ambientAudio.pause(); // Ensure ambient sound is off on reset
            updatePomodoroDisplay();
        }

        /**
         * Skips the current Pomodoro phase and moves to the next, stopping the timer.
         */
        function skipPomodoroPhase() {
            pausePomodoroTimer(); // Ensure timer is paused
            ambientAudio.pause(); // Ensure ambient sound is off on skip
            // If currently studying and time has elapsed, log the completed portion
            if (pomodoroPhase === 'study' && pomodoroCurrentTime < pomodoroStudyTime) {
                 logPomodoroSession(pomodoroStudyTime - pomodoroCurrentTime);
            }
            advancePomodoroPhaseState(); // Set up the next phase
            updatePomodoroDisplay(); // Update display to show next phase/time, but stopped
        }

        /**
         * Advances the Pomodoro timer to the next phase (study, short break, or long break).
         * Does NOT start the timer.
         */
        function advancePomodoroPhaseState() {
            if (pomodoroPhase === 'study') {
                pomodoroCycleCount++;
                if (pomodoroCycleCount % POMODORO_CYCLES_FOR_LONG_BREAK === 0) {
                    pomodoroPhase = 'longBreak';
                    pomodoroCurrentTime = pomodoroLongBreakTime;
                } else {
                    pomodoroPhase = 'shortBreak';
                    pomodoroCurrentTime = pomodoroShortBreakTime;
                }
            } else { // It was a break, go back to study
                pomodoroPhase = 'study';
                pomodoroCurrentTime = pomodoroStudyTime;
            }
            // Do not call startPomodoroTimer() here. User must manually start.
        }

        /**
         * Logs a completed Pomodoro study session.
         * @param {number} durationMs - The duration of the study session in milliseconds.
         */
        function logPomodoroSession(durationMs) {
            const sessionName = `Pomodoro Study #${pomodoroCycleCount}`;
            const sessionEndTime = Date.now();
            const sessionStartTime = sessionEndTime - durationMs; // Calculate start time from end and duration

            const newSession = {
                id: generateUniqueId(),
                name: sessionName,
                startTime: sessionStartTime,
                endTime: sessionEndTime,
                durationMs: durationMs,
            };
            studySessions.push(newSession);

            // Grant XP for the session duration (0.5 XP per minute)
            const xpGained = Math.floor(durationMs / (1000 * 60)) * XP_PER_MINUTE_BASE;
            currentXP += xpGained;
            updateLevel(); // Check for level up
            if (xpGained > 0) {
                showFloatingText(xpInfo, `+${Math.floor(xpGained)} XP`, getComputedStyle(document.documentElement).getPropertyValue('--xp-fill-color'));
            }


            // Grant cash for the session duration with random multiplier
            const cashMultiplier = Math.random() * (CASH_MULTIPLIER_MAX - CASH_MULTIPLIER_MIN) + CASH_MULTIPLIER_MIN;
            const cashGained = Math.floor(Math.floor(durationMs / (1000 * 60)) * CASH_PER_MINUTE_BASE * cashMultiplier);
            currentCash += cashGained;
            renderCash();
            if (cashGained > 0) {
                showFloatingText(cashDisplay, `+$${cashGained}`, getComputedStyle(document.documentElement).getPropertyValue('--accent-green'));
            }

            totalStudyOverallMs += durationMs;
            totalStudyTodayMs += durationMs;

            saveToLocalStorage();
            recalculateStats();
            renderLog();
        }

        /**
         * Saves customized Pomodoro settings and updates the timer.
         */
        async function savePomodoroSettings() {
            const studyMins = parseInt(pomodoroStudyMinsInput.value, 10);
            const shortBreakMins = parseInt(pomodoroShortBreakMinsInput.value, 10);
            const longBreakMins = parseInt(pomodoroLongBreakMinsInput.value, 10);

            if (isNaN(studyMins) || studyMins <= 0 ||
                isNaN(shortBreakMins) || shortBreakMins <= 0 ||
                isNaN(longBreakMins) || longBreakMins <= 0) {
                await showCustomModal('Invalid Input', 'Please enter positive numbers for all Pomodoro durations.');
                return;
            }

            pomodoroStudyTime = studyMins * 60 * 1000;
            pomodoroShortBreakTime = shortBreakMins * 60 * 1000;
            pomodoroLongBreakTime = longBreakMins * 60 * 1000;

            // Update ambient sound settings as well
            updateAmbientSound(); // This will save the selection and volume

            // Reset Pomodoro timer with new settings
            resetPomodoroTimer();
            saveToLocalStorage();
            showCustomModal('Settings Saved!', 'Pomodoro settings updated successfully.');
        }

        /**
         * Updates the ambient background sound based on selection and volume.
         */
        function updateAmbientSound() {
            const selectedSound = ambientSoundSelector.value;
            const newSrc = ambientSoundsMap[selectedSound];

            // Stop current sound if playing
            ambientAudio.pause();
            ambientAudio.currentTime = 0; // Reset playback position

            if (newSrc) {
                ambientAudio.src = newSrc;
                ambientAudio.load(); // Load the new source
                if (pomodoroIsRunning) { // Only play if a sound is selected AND pomodoro is running
                    ambientAudio.play().catch(e => console.error("Ambient sound autoplay prevented:", e));
                }
            }
            saveToLocalStorage(); // Save selected sound and volume
        }


        // --- Log Navigation Functions ---

        /**
         * Scrolls the log entries view to the previous item.
         */
        function scrollLogPrev() {
            currentLogScrollPosition -= logEntryHeight;
            if (currentLogScrollPosition < 0) {
                currentLogScrollPosition = 0;
            }
            studyLogEntries.scrollTo({
                top: currentLogScrollPosition,
                behavior: 'smooth'
            });
        }

        /**
         * Scrolls the log entries view to the next item.
         */
        function scrollLogNext() {
            currentLogScrollPosition += logEntryHeight;
            const maxScroll = studyLogEntries.scrollHeight - studyLogEntries.clientHeight;
            if (currentLogScrollPosition > maxScroll) {
                currentLogScrollPosition = maxScroll;
            }
            studyLogEntries.scrollTo({
                top: currentLogScrollPosition,
                behavior: 'smooth'
            });
        }

        // --- Checklist Functions ---
        function renderChecklist() {
            checklistItemsContainer.innerHTML = '';
            if (checklistItems.length === 0) {
                checklistItemsContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No items yet. Add one above!</p>';
                return;
            }

            checklistItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `checklist-item ${item.completed ? 'completed' : ''}`;
                itemDiv.innerHTML = `
                    <input type="checkbox" data-id="${item.id}" ${item.completed ? 'checked' : ''}
                           class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <span class="flex-grow text-gray-100">${item.text}</span>
                    <button class="delete-checklist-item-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs">
                        Delete
                    </button>
                `;
                checklistItemsContainer.appendChild(itemDiv);
            });

            // Attach event listeners for new checklist items
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => toggleChecklistItem(event.target.dataset.id));
            });
            document.querySelectorAll('.delete-checklist-item-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteChecklistItem(event.target.closest('.checklist-item').querySelector('input[type="checkbox"]').dataset.id));
            });
        }

        function addChecklistItem() {
            const itemText = newChecklistItemInput.value.trim();
            if (itemText) {
                checklistItems.push({ id: generateUniqueId(), text: itemText, completed: false });
                newChecklistItemInput.value = '';
                saveToLocalStorage();
                renderChecklist();
            }
        }

        function toggleChecklistItem(id) {
            const itemIndex = checklistItems.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                checklistItems[itemIndex].completed = !checklistItems[itemIndex].completed;
                saveToLocalStorage();
                renderChecklist();
            }
        }

        async function deleteChecklistItem(id) {
            const confirmed = await showCustomModal(
                'Delete Checklist Item',
                'Are you sure you want to delete this checklist item?',
                true
            );
            if (confirmed) {
                const itemIndex = checklistItems.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    checklistItems.splice(itemIndex, 1);
                    saveToLocalStorage();
                    renderChecklist();
                }
            }
        }

        // --- Individual Notes Functions ---
        function renderIndividualNotes() {
            notesListContainer.innerHTML = '';
            if (individualNotes.length === 0) {
                notesListContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No notes added yet.</p>';
                return;
            }

            individualNotes.forEach(note => {
                const noteDiv = document.createElement('div');
                noteDiv.className = `note-item`; // Use 'note-item' class
                noteDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-100 text-lg">${note.title || 'Untitled Note'}</span>
                        <div class="flex space-x-2">
                            <button class="edit-note-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${note.id}">Edit</button>
                            <button class="delete-note-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${note.id}">Delete</button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm whitespace-pre-wrap">${note.content}</p>
                `;
                notesListContainer.appendChild(noteDiv);
            });

            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteIndividualNote(event.target.dataset.id));
            });
            document.querySelectorAll('.edit-note-btn').forEach(button => {
                button.addEventListener('click', (event) => editIndividualNote(event.target.dataset.id));
            });
        }

        function addIndividualNote() {
            const title = newNoteTitleInput.value.trim();
            const content = newNoteContentInput.value.trim();

            if (!title && !content) {
                showCustomModal('Missing Information', 'Please enter a title or content for your note.');
                return;
            }

            individualNotes.push({ id: generateUniqueId(), title: title, content: content });
            newNoteTitleInput.value = '';
            newNoteContentInput.value = '';
            saveToLocalStorage();
            renderIndividualNotes();
        }

        async function deleteIndividualNote(id) {
            const confirmed = await showCustomModal(
                'Delete Note',
                'Are you sure you want to delete this note?',
                true
            );
            if (confirmed) {
                const index = individualNotes.findIndex(note => note.id === id);
                if (index !== -1) {
                    individualNotes.splice(index, 1);
                    saveToLocalStorage();
                    renderIndividualNotes();
                }
            }
        }

        function editIndividualNote(id) {
            const noteToEdit = individualNotes.find(note => note.id === id);
            if (!noteToEdit) return;

            showCustomModal(
                'Edit Note',
                `
                <div class="flex flex-col gap-3">
                    <label for="edit-note-title" class="block text-sm font-medium text-gray-300 text-left">Title:</label>
                    <input type="text" id="edit-note-title" class="p-2 rounded-md border border-gray-600 bg-gray-700 text-gray-100 w-full" value="${noteToEdit.title}">
                    <label for="edit-note-content" class="block text-sm font-medium text-gray-300 text-left">Content:</label>
                    <textarea id="edit-note-content" class="p-2 rounded-md border border-gray-600 bg-gray-700 text-gray-100 w-full min-h-[100px]">${noteToEdit.content}</textarea>
                </div>
                `,
                true // isConfirm = true, to show "OK" and "Cancel"
            ).then(result => {
                if (result) {
                    const editedTitle = document.getElementById('edit-note-title').value.trim();
                    const editedContent = document.getElementById('edit-note-content').value.trim();

                    if (!editedTitle && !editedContent) {
                         showCustomModal('Invalid Input', 'Note cannot be empty. Please enter a title or content.');
                         return;
                    }

                    noteToEdit.title = editedTitle;
                    noteToEdit.content = editedContent;
                    saveToLocalStorage();
                    renderIndividualNotes();
                }
            });
        }


        // --- Goals Functions (Now in Notepad) ---
        function renderGoals() {
            goalsContainer.innerHTML = '';
            if (studyGoals.length === 0) {
                goalsContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No goals added yet.</p>';
                return;
            }

            studyGoals.forEach(goal => {
                const goalDiv = document.createElement('div');
                goalDiv.className = `goal-item ${goal.completed ? 'completed' : ''}`;

                const dueDateText = goal.dueDate ? ` (Due: ${new Date(goal.dueDate).toLocaleDateString()})` : '';
                const priorityClass = goal.priority ? goal.priority.toLowerCase() : 'medium'; // Default to medium if not set

                goalDiv.innerHTML = `
                    <input type="checkbox" data-id="${goal.id}" ${goal.completed ? 'checked' : ''}
                           class="form-checkbox h-5 w-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500">
                    <span class="font-semibold text-gray-100 goal-text">${goal.name}</span>
                    <span class="priority-tag ${priorityClass}">${goal.priority || 'Medium'}</span>
                    <span class="due-date">${dueDateText}</span>
                    <button class="delete-goal-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${goal.id}">
                        Delete
                    </button>
                    ${goal.description ? `<span class="goal-description">${goal.description}</span>` : ''}
                `;
                goalsContainer.appendChild(goalDiv);
            });

            document.querySelectorAll('.goal-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => toggleGoalCompletion(event.target.dataset.id));
            });
            document.querySelectorAll('.delete-goal-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteGoal(event.target.closest('.goal-item').querySelector('input[type="checkbox"]').dataset.id));
            });
        }

        function addGoal() {
            const goalName = newGoalNameInput.value.trim();
            const goalDescription = newGoalDescriptionInput.value.trim(); // Get description
            const goalPriority = newGoalPriorityInput.value; // Get priority
            const goalDueDate = newGoalDueDateInput.value; //YYYY-MM-DD format
            if (goalName) {
                studyGoals.push({
                    id: generateUniqueId(),
                    name: goalName,
                    description: goalDescription, // Save description
                    priority: goalPriority,     // Save priority
                    dueDate: goalDueDate,
                    completed: false
                });
                newGoalNameInput.value = '';
                newGoalDescriptionInput.value = ''; // Clear description
                newGoalPriorityInput.value = 'Medium'; // Reset priority
                newGoalDueDateInput.value = '';
                saveToLocalStorage();
                renderGoals();
            } else {
                showCustomModal('Missing Information', 'Please enter a goal name.');
            }
        }

        function toggleGoalCompletion(id) {
            const goalIndex = studyGoals.findIndex(goal => goal.id === id);
            if (goalIndex !== -1) {
                studyGoals[goalIndex].completed = !studyGoals[goalIndex].completed;
                if (studyGoals[goalIndex].completed) {
                    // Trigger confetti when a goal is marked complete
                    triggerConfetti(goalsContainer); // Or a more specific element if desired
                }
                saveToLocalStorage();
                renderGoals();
            }
        }

        async function deleteGoal(id) {
            const confirmed = await showCustomModal(
                'Delete Goal',
                'Are you sure you want to delete this goal?',
                true
            );
            if (confirmed) {
                const goalIndex = studyGoals.findIndex(goal => goal.id === id);
                if (goalIndex !== -1) {
                    studyGoals.splice(goalIndex, 1);
                    saveToLocalStorage();
                    renderGoals();
                }
            }
        }

        // --- Resources Functions (Now in Notepad) ---
        function renderResources() {
            resourcesContainer.innerHTML = '';
            if (studyResources.length === 0) {
                resourcesContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No resources added yet.</p>';
                return;
            }

            studyResources.forEach(resource => {
                const resourceDiv = document.createElement('div');
                resourceDiv.className = `resource-item`;
                resourceDiv.innerHTML = `
                    <a href="${resource.url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-400 hover:text-blue-300">
                        ${resource.title}
                    </a>
                    <button class="delete-resource-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs" data-id="${resource.id}">
                        Delete
                    </button>
                `;
                resourcesContainer.appendChild(resourceDiv);
            });

            document.querySelectorAll('.delete-resource-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteResource(event.target.dataset.id));
            });
        }

        function addResource() {
            const title = newResourceTitleInput.value.trim();
            let url = newResourceUrlInput.value.trim();

            if (!title || !url) {
                showCustomModal('Missing Information', 'Please enter both a title and a URL for the resource.');
                return;
            }

            // Basic URL validation and add protocol if missing
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url; // Default to https
            }

            try {
                new URL(url); // Check if it's a valid URL format
            } catch (e) {
                showCustomModal('Invalid URL', 'Please enter a valid URL (e.g., https://example.com).');
                return;
            }

            studyResources.push({ id: generateUniqueId(), title: title, url: url });
            newResourceTitleInput.value = '';
            newResourceUrlInput.value = '';
            saveToLocalStorage();
            renderResources();
        }

        async function deleteResource(id) {
            const confirmed = await showCustomModal(
                'Delete Resource',
                'Are you sure you want to delete this resource?',
                true
            );
            if (confirmed) {
                const resourceIndex = studyResources.findIndex(resource => resource.id === id);
                if (resourceIndex !== -1) {
                    studyResources.splice(resourceIndex, 1);
                    saveToLocalStorage();
                    renderResources();
                }
            }
        }


        // --- Level System Functions ---

        /**
         * Calculates the XP needed for a given level.
         * The formula makes it progressively harder to level up.
         * @param {number} level - The level for which to calculate XP.
         * @returns {number} The amount of XP required to reach this level from the previous one.
         */
        function calculateXPForNextLevel(level) {
            // Much higher XP requirement: baseXP + (level * level * growthFactor)
            return Math.floor(1000 + (level - 1) * 100 + Math.pow(level - 1, 2) * 20); // Adjusted for higher requirements
        }

        /**
         * Gets the title for the current level.
         * @param {number} level - The current level.
         * @returns {string} The title for the level, or "New Learner" as a fallback.
         */
        function getLevelTitle(level) {
            // Find the highest level key that is less than or equal to the current level
            const sortedLevels = Object.keys(LEVEL_TITLES).map(Number).sort((a, b) => b - a);
            for (const key of sortedLevels) {
                if (level >= key) {
                    return LEVEL_TITLES[key];
                }
            }
            return "New Learner"; // Default title for levels below 1
        }

        /**
         * Updates the user's level based on current XP.
         */
        function updateLevel() {
            let leveledUp = false;
            while (currentXP >= xpToNextLevel) {
                currentLevel++;
                xpToNextLevel = calculateXPForNextLevel(currentLevel);
                leveledUp = true;
                const levelTitle = getLevelTitle(currentLevel);
                showCustomModal('Level Up!', `Congratulations! You've reached Level ${currentLevel}: <strong>${levelTitle}</strong>!`, false);
            }
            // Logic to de-level if XP drops (e.g., session deletion)
            while (currentLevel > 1 && currentXP < (calculateXPForNextLevel(currentLevel - 1) || 0)) {
                currentLevel--;
                xpToNextLevel = calculateXPForNextLevel(currentLevel); // Recalculate based on new level
            }
            updateXPBar(); // Always update the bar after XP/level changes
            saveToLocalStorage(); // Persist changes
            renderShop(); // Re-render shop to update unlock statuses
            renderInvestments(); // Re-render investments as options might change
        }

        /**
         * Updates the visual XP bar and text.
         */
        function updateXPBar() {
            const xpNeededForCurrentLevel = calculateXPForNextLevel(currentLevel);
            const xpFromPreviousLevel = (currentLevel > 1) ? calculateXPForNextLevel(currentLevel - 1) : 0;
            const xpProgressInCurrentLevel = currentXP - xpFromPreviousLevel;
            const xpNeededForNextLevelSegment = xpNeededForCurrentLevel - xpFromPreviousLevel;

            let progressPercentage;
            if (xpNeededForNextLevelSegment <= 0) {
                progressPercentage = 100;
            } else {
                progressPercentage = (xpProgressInCurrentLevel / xpNeededForNextLevelSegment) * 100;
            }
            progressPercentage = Math.min(100, Math.max(0, progressPercentage));

            xpBarFill.style.width = `${progressPercentage}%`;
            const currentTitle = getLevelTitle(currentLevel);
            xpInfo.textContent = `${Math.floor(xpProgressInCurrentLevel)} / ${xpNeededForNextLevelSegment} XP`;
            levelDisplay.textContent = `Level ${currentLevel} (${currentTitle})`;

            const isStudyTrackerActive = navStudyTracker.classList.contains('active');
            xpCashWrapper.classList.toggle('hidden', !isStudyTrackerActive);
        }

        /**
         * Renders the current cash amount.
         */
        function renderCash() {
            cashDisplay.textContent = `$${currentCash.toLocaleString()}`;
            const isStudyTrackerActive = navStudyTracker.classList.contains('active');
            xpCashWrapper.classList.toggle('hidden', !isStudyTrackerActive);
        }


        // --- AI Assistant Functions ---
        function renderChatHistory() {
            chatWindow.innerHTML = '';
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.role}-message`;
                messageDiv.innerHTML = `<p>${formatTextWithMarkdown(message.parts[0].text)}</p>`;
                chatWindow.appendChild(messageDiv);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendChatMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // Ensure API key is present
            if (!geminiApiKey) {
                showCustomModal('API Key Required', 'Please enter your Gemini API Key to use the AI Assistant.');
                return;
            }

            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            renderChatHistory();
            userInput.value = '';
            loadingIndicator.classList.remove('hidden');

            try {
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                } else {
                    console.error("Unexpected API response structure:", result);
                    chatHistory.push({ role: "model", parts: [{ text: "I'm sorry, I couldn't get a response. There might be an issue with the API or your key. Please try again later." }] });
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                chatHistory.push({ role: "model", parts: [{ text: "I'm having trouble connecting right now. Please check your internet connection or confirm your API key is correct and valid." }] });
            } finally {
                loadingIndicator.classList.add('hidden');
                renderChatHistory();
                saveToLocalStorage();
            }
        }

        function saveGeminiApiKey() {
            const key = geminiApiKeyInput.value.trim();
            if (key) {
                geminiApiKey = key;
                localStorage.setItem('geminiApiKey', geminiApiKey);
                showCustomModal('API Key Saved', 'Your Gemini API key has been saved locally. The AI Assistant should now work.');
            } else {
                showCustomModal('Empty API Key', 'Please enter your Gemini API key before saving.');
            }
        }

        function clearGeminiApiKey() {
            geminiApiKey = "";
            localStorage.removeItem('geminiApiKey');
            geminiApiKeyInput.value = "";
            showCustomModal('API Key Cleared', 'Your Gemini API key has been cleared from local storage. The AI Assistant will not function until a new key is provided.');
        }


        // --- Daily Focus Functions (Now hardcoded quotes) ---
        function displayDailyTip() {
            dailyFocusText.innerHTML = formatTextWithMarkdown(dailyTips[currentTipIndex]);
            currentTipIndex = (currentTipIndex + 1) % dailyTips.length; // Cycle through tips
            localStorage.setItem('currentTipIndex', currentTipIndex); // Save current index
        }


        // --- Shop Functions (NEW) ---

        /**
         * Calculates the total XP required to reach a specific level.
         * @param {number} targetLevel - The level to reach.
         * @returns {number} Total XP required.
         */
        function getTotalXPForLevel(targetLevel) {
            let totalXp = 0;
            // The XP required for a level is the XP *to reach* that level.
            // So, for level 1, it's 100. For level 2, it's 100 + calculateXPForNextLevel(2), etc.
            // Adjusting this to be the total accumulated XP *to have achieved* that level.
            for (let i = 1; i <= targetLevel; i++) {
                totalXp += calculateXPForNextLevel(i);
            }
            return totalXp;
        }


        /**
         * Renders the shop items (skins).
         */
        function renderShop() {
            shopSkinsContainer.innerHTML = ''; // Clear existing skins

            skins.forEach(skin => {
                // Determine if the skin is unlocked
                if (skin.levelRequired === 0 && skin.cost === 0) {
                    skin.unlocked = true; // Default skins are always unlocked
                } else if (currentLevel >= skin.levelRequired && !skin.unlocked) {
                    // Automatically unlock if criteria met and not already marked unlocked
                    skin.unlocked = true;
                    saveToLocalStorage(); // Save the new unlocked status
                }

                const isLocked = currentLevel < skin.levelRequired;
                const canAfford = currentCash >= skin.cost;
                const isCurrentSkin = activeSkinId === skin.id;

                let buttonText = 'Select';
                let buttonDisabled = false;
                let buttonClasses = 'bg-blue-500 hover:bg-blue-600';

                if (isLocked) {
                    buttonText = `Unlock (Level ${skin.levelRequired})`;
                    buttonDisabled = true;
                    buttonClasses = 'bg-gray-500 cursor-not-allowed';
                } else if (!skin.unlocked && !canAfford) { // Not unlocked, can't afford
                    buttonText = `Purchase ($${skin.cost.toLocaleString()})`;
                    buttonDisabled = true;
                    buttonClasses = 'bg-red-500 cursor-not-allowed';
                } else if (!skin.unlocked && canAfford) { // Not unlocked, but CAN afford
                    buttonText = `Purchase ($${skin.cost.toLocaleString()})`;
                    buttonClasses = 'bg-green-500 hover:bg-green-600';
                } else if (isCurrentSkin) { // Already unlocked and is current skin
                    buttonText = 'Current Skin';
                    buttonDisabled = true;
                    buttonClasses = 'bg-gray-700 cursor-not-allowed';
                } else if (skin.unlocked && !isCurrentSkin) { // Unlocked but not current
                    buttonText = 'Select';
                    buttonClasses = 'bg-blue-500 hover:bg-blue-600';
                }


                // Calculate study hours to unlock if locked
                let studyHoursInfo = '';
                if (isLocked) {
                    const currentTotalXP = getTotalXPForLevel(currentLevel); // Total XP accumulated up to current level
                    const requiredTotalXP = getTotalXPForLevel(skin.levelRequired); // Total XP needed to reach skin's required level
                    const remainingXp = Math.max(0, requiredTotalXP - currentXP); // XP needed from current state
                    const hoursRemaining = Math.ceil(remainingXp / (XP_PER_MINUTE_BASE * 60)); // Convert XP to hours based on base XP_PER_MINUTE
                    studyHoursInfo = `<p class="text-xs text-gray-400 mt-1">~${hoursRemaining} hrs to unlock</p>`;
                }


                const skinCard = document.createElement('div');
                skinCard.className = `shop-skin-card rounded-xl shadow-lg p-4 text-center ${isLocked ? 'locked' : ''} ${isCurrentSkin ? 'current-skin' : ''}`;
                skinCard.innerHTML = `
                    <div class="shop-skin-preview ${skin.bodyClass}"></div>
                    <h3 class="text-lg font-semibold mt-2">${skin.name}</h3>
                    <p class="text-sm text-gray-300">Level Required: ${skin.levelRequired}</p>
                    <p class="text-sm text-gray-300">Cost: ${skin.cost.toLocaleString()} <span class="text-green-400">$</span></p>
                    ${studyHoursInfo}
                    <button data-id="${skin.id}"
                            class="mt-3 w-full py-2 px-4 rounded-md font-bold transition duration-300 ease-in-out ${buttonClasses}"
                            ${buttonDisabled ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;
                shopSkinsContainer.appendChild(skinCard);

                // Add event listener to the button
                skinCard.querySelector('button').addEventListener('click', (event) => {
                    const skinId = event.target.dataset.id;
                    const targetSkin = skins.find(s => s.id === skinId);
                    if (!targetSkin) return;

                    if (isLocked) {
                        showCustomModal('Locked Skin', `You need to reach Level ${targetSkin.levelRequired} to unlock this skin. Keep studying!`);
                    } else if (!targetSkin.unlocked && !canAfford) {
                        showCustomModal('Not Enough Money', `You need $${targetSkin.cost.toLocaleString()} to purchase this skin. You currently have $${currentCash.toLocaleString()}.`);
                    } else if (!targetSkin.unlocked && canAfford) {
                        purchaseSkin(skinId);
                    } else { // Already unlocked or default, just apply
                        applySkin(skinId);
                    }
                });
            });
        }

        /**
         * Purchases a skin.
         * @param {string} skinId - The ID of the skin to purchase.
         */
        async function purchaseSkin(skinId) {
            const skin = skins.find(s => s.id === skinId);
            if (!skin || skin.unlocked || currentCash < skin.cost || currentLevel < skin.levelRequired) {
                showCustomModal('Error', 'Cannot purchase skin. Check requirements and funds.');
                return;
            }

            const confirmed = await showCustomModal(
                'Confirm Purchase',
                `Are you sure you want to purchase "${skin.name}" for $${skin.cost.toLocaleString()}?`,
                true
            );

            if (confirmed) {
                currentCash -= skin.cost;
                skin.unlocked = true;
                activeSkinId = skinId; // Automatically select after purchase
                saveToLocalStorage();
                renderCash();
                renderShop(); // Re-render shop to update buttons
                applySkin(skinId, false); // Apply the new skin without re-saving
                showCustomModal('Purchase Successful!', `You've unlocked and applied the "${skin.name}" skin!`);
            }
        }

        /**
         * Applies a selected skin to the body.
         * @param {string} skinId - The ID of the skin to apply.
         * @param {boolean} shouldSave - Whether to save the active skin to local storage. Default true.
         */
        function applySkin(skinId, shouldSave = true) {
            const body = document.body;
            // Remove all existing skin classes
            skins.forEach(skin => {
                body.classList.remove(skin.bodyClass);
            });

            const selectedSkin = skins.find(s => s.id === skinId);
            if (selectedSkin && selectedSkin.unlocked) {
                body.classList.add(selectedSkin.bodyClass);
                activeSkinId = skinId;
                if (shouldSave) {
                    saveToLocalStorage();
                }
            } else if (skinId === 'default-dark') { // Fallback if somehow active skin is locked
                 body.classList.add('default-dark-skin');
                 activeSkinId = 'default-dark';
                 if (shouldSave) {
                    saveToLocalStorage();
                }
            }
            renderShop(); // Update shop buttons to reflect current skin
        }


        // --- Main Mode Switching Functions (Stopwatch/Pomodoro/Stats) ---

        /**
         * Shows the selected mode view (stopwatch, pomodoro, or stats) within the main tracker.
         * Hides other views.
         * @param {string} mode - 'stopwatch', 'pomodoro', or 'stats'.
         */
        function showMainModeView(mode) {
            stopwatchView.classList.add('hidden');
            pomodoroView.classList.add('hidden');
            // Removed statsView.classList.add('hidden'); as the main stats are now always present in Study Tracker
            statsView.classList.add('hidden'); // This is the old "Advanced Stats" tab, which is now just a placeholder.

            modeStopwatchBtn.classList.remove('active-mode');
            modePomodoroBtn.classList.remove('active-mode');
            modeStatsSubBtn.classList.remove('active-mode');

            if (mode === 'stopwatch') {
                stopwatchView.classList.remove('hidden');
                modeStopwatchBtn.classList.add('active-mode');
            } else if (mode === 'pomodoro') {
                pomodoroView.classList.remove('hidden');
                modePomodoroBtn.classList.add('active-mode');
                // Ensure pomodoro display is updated when shown
                updatePomodoroDisplay();
            } else if (mode === 'stats') {
                statsView.classList.remove('hidden'); // Show the dedicated stats area within study tracker
                modeStatsSubBtn.classList.add('active-mode');
                // Ensure stats are re-rendered if needed (recalculateStats already calls renderStats)
                renderStats();
            }
            currentDisplayMode = mode;

            // Pause any running timer when switching modes within the main tracker
            if (isRunning) stopTimer();
            if (pomodoroIsRunning) pausePomodoroTimer();
        }


        // --- Top-level Tab Switching Functions ---

        /**
         * Shows the selected top-level tab and hides others.
         * @param {string} tabId - ID of the tab section (e.g., 'main-tracker-section', 'notepad-section').
         */
        function showTab(tabId) {
            // Hide all main content sections and remove active class
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.remove('active');
                section.classList.add('hidden');
            });


            // Hide daily focus container by default, only show for specific tabs
            dailyFocusContainer.classList.add('hidden');


            // Show the selected section
            const targetSection = document.getElementById(tabId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                setTimeout(() => { // Small delay to allow 'hidden' to apply before 'active' for transition
                    targetSection.classList.add('active');
                }, 10);
            }


            // Update active state for main navigation buttons
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            // This handles mapping section IDs to nav button IDs correctly
            document.getElementById(`nav-${tabId.replace('-section', '').replace('main-tracker', 'study-tracker')}`).classList.add('active');


            // Special handling for the main tracker to manage stopwatch/pomodoro/stats sub-views
            if (tabId === 'main-tracker-section') {
                // When coming back to main-tracker-section, show the last active mode
                showMainModeView(currentDisplayMode);
                xpCashWrapper.classList.remove('hidden'); // Show XP/Cash wrapper on study tracker tab
                dailyFocusContainer.classList.remove('hidden'); // Show daily focus on study tracker
            } else {
                // Ensure timers are stopped if not on the main tracker page
                if (isRunning) stopTimer();
                if (pomodoroIsRunning) pausePomodoroTimer();
                xpCashWrapper.classList.add('hidden'); // Hide XP/Cash wrapper on other tabs
            }
            // Ensure shop is rendered when shop tab is selected
            if (tabId === 'shop-section') {
                renderShop();
            }
            // Ensure daily focus is visible on Notepad tab
            if (tabId === 'notepad-section') {
                dailyFocusContainer.classList.remove('hidden');
            }
            // Ensure investments are rendered when capitalist tab is selected
            if (tabId === 'capitalist-section') {
                renderInvestments();
            }
        }


        // --- StudyFlow Capitalist Game Logic (NEW) ---

        /**
         * Defines investment options with their base ROI, duration, and level requirements.
         */
        const investmentOptions = [
            // Bonds (more stable, guaranteed min ROI)
            { id: 'bond-1hr', name: 'Basic Study Bond', type: 'bond', durationMs: 3600000, baseMinROI: 0.05, baseMaxROI: 0.10, levelRequired: 1, xpReward: 5, riskFactor: 0 }, // 1 hour, 5-10%
            { id: 'bond-6hr', name: 'Intermediate Study Bond', type: 'bond', durationMs: 21600000, baseMinROI: 0.10, baseMaxROI: 0.20, levelRequired: 5, xpReward: 15, riskFactor: 0 }, // 6 hours, 10-20%
            { id: 'bond-24hr', name: 'Advanced Study Bond', type: 'bond', durationMs: 86400000, baseMinROI: 0.20, baseMaxROI: 0.40, levelRequired: 10, xpReward: 30, riskFactor: 0 }, // 24 hours, 20-40%

            // Ventures (higher risk/reward, can lose money)
            { id: 'venture-short', name: 'Startup Study Venture', type: 'venture', durationMs: 1800000, baseMinROI: -0.10, baseMaxROI: 0.20, levelRequired: 3, xpReward: 10, riskFactor: 0.5 }, // 30 mins, -10% to 20%
            { id: 'venture-medium', name: 'Research Project', type: 'venture', durationMs: 10800000, baseMinROI: -0.20, baseMaxROI: 0.50, levelRequired: 8, xpReward: 25, riskFactor: 0.7 }, // 3 hours, -20% to 50%
            { id: 'venture-long', name: 'Edu-Tech Innovation', type: 'venture', durationMs: 43200000, baseMinROI: -0.30, baseMaxROI: 1.00, levelRequired: 13, xpReward: 50, riskFactor: 1.0 } // 12 hours, -30% to 100%
        ];

        /**
         * Initiates an investment.
         */
        async function makeInvestment() {
            const amount = parseInt(investmentAmountInput.value, 10);
            const type = investmentTypeSelect.value;
            const durationMs = parseInt(investmentDurationSelect.value, 10);

            // Find the chosen option to get its base ROI and level requirements
            const selectedOption = investmentOptions.find(opt => opt.type === type && opt.durationMs === durationMs && currentLevel >= opt.levelRequired);

            if (!selectedOption) {
                await showCustomModal('Investment Not Available', 'This investment option is not available at your current level or combination selected. Please check requirements.');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                await showCustomModal('Invalid Amount', 'Please enter a positive amount to invest.');
                return;
            }
            if (amount > currentCash) {
                await showCustomModal('Insufficient Funds', `You need $${amount.toLocaleString()} for this investment, but you only have $${currentCash.toLocaleString()}.`);
                return;
            }

            currentCash -= amount; // Deduct money immediately
            renderCash();

            // Calculate actual ROI range based on level
            let minROI = selectedOption.baseMinROI;
            let maxROI = selectedOption.baseMaxROI;

            // Increase lucrativeness and risk with level (example scaling)
            const levelBonusFactor = Math.min(1.5, 1 + (currentLevel / 20)); // Scales up to 1.5x at level 20
            if (selectedOption.type === 'bond') {
                minROI *= levelBonusFactor;
                maxROI *= levelBonusFactor;
            } else { // Venture, also increase risk (wider range, more negative potential)
                minROI *= levelBonusFactor * (1 - selectedOption.riskFactor);
                maxROI *= levelBonusFactor * (1 + selectedOption.riskFactor);
            }

            const newInvestment = {
                id: generateUniqueId(),
                amount: amount,
                type: type,
                durationMs: durationMs,
                startTime: Date.now(),
                endTime: Date.now() + durationMs,
                minROI: minROI,
                maxROI: maxROI,
                xpReward: selectedOption.xpReward,
                matured: false,
                result: null // 'profit', 'loss', 'even'
            };
            investments.push(newInvestment);
            saveToLocalStorage();
            renderInvestments();
            await showCustomModal('Investment Placed!', `You invested $${amount.toLocaleString()} in a ${selectedOption.name}. Check back later to see your returns!`);
        }

        /**
         * Calculates returns and collects earnings for a matured investment.
         * @param {string} id - The ID of the investment to collect.
         */
        async function collectInvestment(id) {
            const index = investments.findIndex(inv => inv.id === id);
            if (index === -1) return;

            const investment = investments[index];
            if (!investment.matured) {
                await showCustomModal('Investment Not Matured', 'This investment has not matured yet.');
                return;
            }

            // Calculate actual ROI within the range (simulating random market fluctuation)
            const actualROI = investment.minROI + (Math.random() * (investment.maxROI - investment.minROI));
            const returnAmount = Math.floor(investment.amount * actualROI);
            const totalReturn = investment.amount + returnAmount;

            currentCash += totalReturn; // Add returns to cash
            renderCash();

            let message = '';
            if (returnAmount > 0) {
                message = `Your ${investment.type === 'bond' ? 'bond' : 'venture'} matured! You earned $${returnAmount.toLocaleString()} profit, for a total of $${totalReturn.toLocaleString()}.`;
                showFloatingText(cashDisplay, `+$${returnAmount}`, getComputedStyle(document.documentElement).getPropertyValue('--accent-green'));
                // Award XP for successful investments
                currentXP += investment.xpReward;
                updateLevel();
                showFloatingText(xpInfo, `+${investment.xpReward} XP`, getComputedStyle(document.documentElement).getPropertyValue('--xp-fill-color'));
                investment.result = 'profit';
            } else if (returnAmount < 0) {
                message = `Your ${investment.type === 'bond' ? 'bond' : 'venture'} matured with a loss! You lost $${Math.abs(returnAmount).toLocaleString()}, resulting in $${totalReturn.toLocaleString()}.`;
                showFloatingText(cashDisplay, `-$${Math.abs(returnAmount)}`, getComputedStyle(document.documentElement).getPropertyValue('--accent-red'));
                investment.result = 'loss';
            } else {
                message = `Your ${investment.type === 'bond' ? 'bond' : 'venture'} broke even. You got your $${investment.amount.toLocaleString()} back.`;
                investment.result = 'even';
            }

            investments.splice(index, 1); // Remove from active investments
            saveToLocalStorage();
            renderInvestments(); // Re-render to update list

            await showCustomModal('Investment Result', message);
        }

        /**
         * Renders the list of active and matured investments.
         */
        function renderInvestments() {
            investmentListContainer.innerHTML = '';
            if (investments.length === 0) {
                investmentListContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No active investments.</p>';
                return;
            }

            const now = Date.now();
            investments.forEach(investment => {
                let timeLeftMs = investment.endTime - now;
                let progressPercentage = Math.min(100, Math.max(0, ((now - investment.startTime) / investment.durationMs) * 100));

                let statusText = '';
                let buttonHtml = '';
                let cardClass = '';

                if (timeLeftMs <= 0) {
                    investment.matured = true;
                    statusText = 'Matured!';
                    cardClass = 'matured';
                    // Re-calculate result on render if not already calculated (e.g., first load)
                    if (investment.result === null) {
                         const actualROI = investment.minROI + (Math.random() * (investment.maxROI - investment.minROI));
                         const returnAmount = Math.floor(investment.amount * actualROI);
                         if (returnAmount > 0) { investment.result = 'profit'; }
                         else if (returnAmount < 0) { investment.result = 'loss'; }
                         else { investment.result = 'even'; }
                    }
                    buttonHtml = `<button class="collect-investment-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out w-full" data-id="${investment.id}">Collect</button>`;
                    if (investment.result === 'loss') {
                        cardClass = 'lost';
                    } else if (investment.result === 'profit') {
                        cardClass = 'matured';
                    }
                } else {
                    statusText = `Time Left: ${formatTime(timeLeftMs)}`;
                    cardClass = '';
                    buttonHtml = `<button class="collect-investment-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-full w-full cursor-not-allowed" disabled>Collect</button>`;
                }

                const investmentDiv = document.createElement('div');
                investmentDiv.className = `investment-card p-4 rounded-xl shadow-md ${cardClass}`;
                investmentDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-100">${investment.type === 'bond' ? 'Study Bond' : 'Study Venture'}</span>
                        <span class="text-gray-200">$${investment.amount.toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-300 mb-2">
                        <span>Expected ROI: ${Math.floor(investment.minROI * 100)}% to ${Math.floor(investment.maxROI * 100)}%</span>
                        ${investment.type === 'venture' ? '<span class="text-red-400 ml-2">(Volatile!)</span>' : ''}
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2 progress-bar">
                        <div class="h-2.5 rounded-full progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <p class="text-sm text-gray-400 mb-3">${statusText}</p>
                    ${buttonHtml}
                `;
                investmentListContainer.appendChild(investmentDiv);
            });

            document.querySelectorAll('.collect-investment-btn').forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', (event) => collectInvestment(event.target.dataset.id));
                }
            });
            saveToLocalStorage(); // To persist matured status etc.
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startTimer);
        stopBtn.addEventListener('click', stopTimer);
        addLogBtn.addEventListener('click', addSessionToLog);
        clearLogBtn.addEventListener('click', clearAllSessions);
        setDailyGoalBtn.addEventListener('click', openGoalModal);

        prevLogBtn.addEventListener('click', scrollLogPrev);
        nextLogBtn.addEventListener('click', scrollLogNext);

        // Pomodoro Buttons
        pomodoroStartBtn.addEventListener('click', startPomodoroTimer);
        pomodoroPauseBtn.addEventListener('click', pausePomodoroTimer);
        pomodoroResetBtn.addEventListener('click', resetPomodoroTimer);
        pomodoroSkipBtn.addEventListener('click', skipPomodoroPhase);
        savePomodoroSettingsBtn.addEventListener('click', savePomodoroSettings); // New listener for settings
        togglePomodoroSettingsBtn.addEventListener('click', () => {
            pomodoroSettings.classList.toggle('hidden');
        });
        ambientSoundSelector.addEventListener('change', updateAmbientSound); // Updated listener for ambient sound
        ambientVolumeSlider.addEventListener('input', (event) => {
            ambientAudio.volume = parseFloat(event.target.value);
            saveToLocalStorage(); // Save volume setting
        });


        // Mode Switchers within Study Tracker Tab
        modeStopwatchBtn.addEventListener('click', () => showMainModeView('stopwatch'));
        modePomodoroBtn.addEventListener('click', () => showMainModeView('pomodoro'));
        modeStatsSubBtn.addEventListener('click', () => showMainModeView('stats'));


        // Edit Modal Listeners
        editModalCloseBtn.addEventListener('click', closeEditModal);
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', saveEditedSession);

        // Goal Modal Listeners
        goalModalCloseBtn.addEventListener('click', closeGoalModal);
        cancelGoalBtn.addEventListener('click', closeGoalModal);
        saveGoalBtn.addEventListener('click', saveGoalTimes);

        // Custom Modal Close Listener
        customModalCloseBtn.addEventListener('click', () => customModalOverlay.classList.add('hidden'));

        // Top-level Tab navigation listeners
        navStudyTracker.addEventListener('click', () => showTab('main-tracker-section'));
        navNotepad.addEventListener('click', () => showTab('notepad-section'));
        navShop.addEventListener('click', () => showTab('shop-section')); // NEW
        navCapitalist.addEventListener('click', () => showTab('capitalist-section')); // NEW
        navAbout.addEventListener('click', () => showTab('about-section'));
        navAIAssistant.addEventListener('click', () => showTab('ai-assistant-section'));


        // Checklist event listeners
        addChecklistItemBtn.addEventListener('click', addChecklistItem);
        newChecklistItemInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                addChecklistItem();
            }
        });

        // Notes (Individual) event listeners
        addNoteBtn.addEventListener('click', addIndividualNote);
        newNoteTitleInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && (newNoteTitleInput.value.trim() !== '' || newNoteContentInput.value.trim() !== '')) {
                addIndividualNote();
            }
        });
        newNoteContentInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && (newNoteTitleInput.value.trim() !== '' || newNoteContentInput.value.trim() !== '')) {
                if (!event.shiftKey) { // Allow Shift+Enter for new line
                    addIndividualNote();
                    event.preventDefault(); // Prevent default Enter behavior (e.g., new line in textarea)
                }
            }
        });


        // Goals event listeners (Now in Notepad)
        addGoalBtn.addEventListener('click', addGoal);
        newGoalNameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && newGoalNameInput.value.trim() !== '') {
                addGoal();
            }
        });
        newGoalDescriptionInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && newGoalNameInput.value.trim() !== '') {
                addGoal();
            }
        });
        newGoalDueDateInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && newGoalNameInput.value.trim() !== '') {
                addGoal();
            }
        });


        // Resources event listeners (Now in Notepad)
        addResourceBtn.addEventListener('click', addResource);
        newResourceTitleInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && newResourceUrlInput.value.trim() !== '') {
                addResource();
            }
        });
        newResourceUrlInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && newResourceTitleInput.value.trim() !== '') {
                addResource();
            }
        });

        // AI Assistant Event Listeners
        sendChatBtn.addEventListener('click', sendChatMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        });
        saveApiKeyBtn.addEventListener('click', saveGeminiApiKey);
        clearApiKeyBtn.addEventListener('click', clearGeminiApiKey);

        // Daily Focus Event Listener (Now cycles through hardcoded tips)
        getDailyFocusBtn.addEventListener('click', displayDailyTip);

        // Capitalist Game Event Listeners (NEW)
        investBtn.addEventListener('click', makeInvestment);


        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (event) => {
            // Prevent hotkeys from firing if an input field is focused
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }

            // Only apply stopwatch/pomodoro shortcuts if on the main tracker section
            if (document.getElementById('main-tracker-section').classList.contains('hidden') === false) {
                if (currentDisplayMode === 'stopwatch') {
                    if (event.key === 's' || event.key === 'S') {
                        if (!startBtn.classList.contains('hidden')) {
                            startBtn.click();
                        }
                    } else if (event.key === 'p' || event.key === 'P') {
                        if (!stopBtn.classList.contains('hidden')) {
                            stopBtn.click();
                        }
                    } else if (event.key === 'l' || event.key === 'L') {
                        if (!addLogBtn.disabled) {
                            addLogBtn.click();
                        }
                    }
                } else if (currentDisplayMode === 'pomodoro') {
                    if (event.key === 's' || event.key === 'S') { // Reuse 'S' for start in Pomodoro
                         if (!pomodoroStartBtn.classList.contains('hidden')) {
                            pomodoroStartBtn.click();
                        }
                    } else if (event.key === 'p' || event.key === 'P') { // Reuse 'P' for pause in Pomodoro
                         if (!pomodoroPauseBtn.classList.contains('hidden')) {
                            pomodoroPauseBtn.click();
                        }
                    } else if (event.key === 'r' || event.key === 'R') { // 'R' for reset
                        pomodoroResetBtn.click();
                    } else if (event.key === 'k' || event.key === 'K') { // 'K' for skip
                        pomodoroSkipBtn.click();
                    }
                }
            }


            // Log navigation shortcuts (independent of mode or main tab)
            if (event.key === 'ArrowLeft') {
                 scrollLogPrev();
            } else if (event.key === 'ArrowRight') {
                 scrollLogNext();
            }
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateHourDropdowns();
            loadFromLocalStorage();
            renderStats();
            renderLog();
            renderChecklist();
            renderIndividualNotes();
            renderResources(); // Render resources in Notepad
            renderGoals(); // Render goals in Notepad
            setStopwatchButtonStates();
            updatePomodoroDisplay();

            // Set initial tab to Study Tracker and show its default mode (stopwatch)
            showTab('main-tracker-section');
            showMainModeView('stopwatch');
            navStudyTracker.classList.add('active');
            updateXPBar();
            renderCash();

            // Display the initial daily tip
            currentTipIndex = parseInt(localStorage.getItem('currentTipIndex') || '0', 10);
            displayDailyTip();


            // Check if goal has been set, otherwise prompt
            const hasSetGoal = localStorage.getItem('hasSetGoal');
            if (!hasSetGoal) {
                openGoalModal();
            }
            // Periodically update investments progress
            setInterval(renderInvestments, 1000); // Update every second to show progress
        });
    </script>
</body>
</html>
